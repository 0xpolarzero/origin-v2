# API-005 Plan: Establish Enforceable Validation Commands (TDD First)

## Overview of the approach
This ticket hardens workflow validation so every API/data implementation slice is forced through root `typecheck` and `test` gate commands, aligned with:
- `docs/engineering.choices.md:25` (run typecheck + relevant tests per slice)
- `docs/engineering.choices.md:41` (workflow must validate with typecheck/tests before progressing)

The repository already has root scripts and gate plumbing, so this plan focuses on closing enforcement gaps:
1. Lock required root script contract with explicit tests.
2. Ensure API tickets categorized as `testing` still resolve to API/data-focused suites.
3. Detect and eliminate generated workflow script drift from `package.json`.

Execution model:
1. Add one failing test.
2. Apply the smallest implementation change to pass that test.
3. Commit atomic slices after relevant tests/typecheck pass.

## TDD step order (tests before implementation)
1. **Test:** `tests/unit/workflow/gate-config.test.ts`
   Add assertion that required root scripts are enforceable and non-empty (`test`, `typecheck`) even when whitespace variants are provided.
   **Implement:** `node_modules/super-ralph/src/cli/gate-config.ts`
   Update `hasScript(...)` and/or `assertRequiredGateScripts(...)` only if the test reveals a gap.

2. **Test:** `tests/integration/workflow-gate-policy.integration.test.ts`
   Strengthen `package scripts required by workflow gates remain defined and non-empty` to assert exact root keys and expected command shape for:
   - `test`
   - `typecheck`
   - `test:integration:api`
   - `test:integration:db`
   **Implement:** `/package.json`
   Add/fix root scripts only if assertions fail.

3. **Test:** `tests/unit/workflow/ticket-gates.test.ts`
   Add focused case: API ticket classified as `testing` resolves API slice command (`bun run test:integration:api`) instead of broad fallback.
   **Implement:** `node_modules/super-ralph/src/components/ticket-gates.ts`
   Introduce category+ticket normalization helper and wire it into category test resolution.

4. **Test:** `tests/unit/workflow/ticket-gates.test.ts`
   Add case ensuring `resolveVerifyCommands(...)` for API `testing` tickets yields `typecheck + api suite`, with no duplicates.
   **Implement:** `node_modules/super-ralph/src/components/ticket-gates.ts`
   Ensure `resolveVerifyCommands(...)` uses the new focus resolution path.

5. **Test:** `tests/unit/workflow/super-ralph-wiring.test.tsx`
   Add/extend fixture ticket (`API-005`, category `testing`) and assert implement/test/review-fix prompts receive API-focused gate commands.
   **Implement:** `node_modules/super-ralph/src/components/SuperRalph.tsx`
   Pass ticket identity/context needed by gate resolution:
   - `resolveTicketGateSelection({ ticketId: ticket.id, ticketCategory: ticket.category, ... })`

6. **Test:** `tests/integration/workflow-gate-policy.integration.test.ts`
   Add integration assertion that `resolveTicketGateSelection(...)` for `ticketId: "API-005"` + `ticketCategory: "testing"` includes:
   - `bun run typecheck`
   - `bun run test:integration:api`
   **Implement:** `node_modules/super-ralph/src/components/ticket-gates.ts` (if still failing after step 3-5).

7. **Test:** `tests/unit/workflow/generated-workflow-gates.test.ts`
   Add assertion that generated `PACKAGE_SCRIPTS` required keys mirror root `package.json` values (especially `typecheck` and `test`).
   **Implement:** `/.super-ralph/generated/workflow.tsx`
   Regenerate or update generated artifact so embedded scripts match `package.json`.

8. **Test:** `tests/integration/workflow-gate-policy.integration.test.ts`
   Add artifact-level check that generated workflow script map does not drift for required gate keys at runtime.
   **Implement:** regenerate workflow from Super Ralph CLI path and keep committed artifact current.

9. **Test:** `tests/unit/workflow/patch-regression.test.ts`
   Add regression checks for any newly touched `super-ralph` patch sections (`ticket-gates`, `gate-config`, or `SuperRalph` wiring markers).
   **Implement:** `/patches/super-ralph-codex-schema.patch`
   Refresh patch file to persist `node_modules/super-ralph` source edits.

## Files to create/modify (with specific function signatures)

### Create
- None expected.

### Modify (tests)
- `/tests/unit/workflow/gate-config.test.ts`
- `/tests/unit/workflow/ticket-gates.test.ts`
- `/tests/unit/workflow/super-ralph-wiring.test.tsx`
- `/tests/unit/workflow/generated-workflow-gates.test.ts`
- `/tests/unit/workflow/patch-regression.test.ts`
- `/tests/integration/workflow-gate-policy.integration.test.ts`

### Modify (implementation)
- `/package.json`
  - root scripts contract:
    - `"test": string`
    - `"typecheck": string`

- `/node_modules/super-ralph/src/components/ticket-gates.ts`
  - `export type ResolveTicketGateSelectionParams = { ticketId?: string; ticketCategory: string; buildCmds: Record<string, string>; testCmds: Record<string, string>; preLandChecks: string[]; }`
  - `const normalizeCategory = (ticketCategory: string, ticketId?: string): string`
  - `export const resolveCategoryTestCommand = (ticketCategory: string, testCmds: Record<string, string>, ticketId?: string): string`
  - `export const resolveVerifyCommands = (params: ResolveTicketGateSelectionParams): string[]`
  - `export const resolveTicketGateSelection = (params: ResolveTicketGateSelectionParams): TicketGateSelection`

- `/node_modules/super-ralph/src/components/SuperRalph.tsx`
  - call-site wiring:
    - `resolveTicketGateSelection({ ticketId: ticket.id, ticketCategory: ticket.category, buildCmds, testCmds, preLandChecks })`

- `/.super-ralph/generated/workflow.tsx`
  - `const PACKAGE_SCRIPTS = { ... }` must mirror root required scripts for gate keys.

- `/patches/super-ralph-codex-schema.patch`
  - persist super-ralph source edits for reproducible installs.

## Tests to write (unit + integration)

### Unit tests
- `gate-config`:
  - required root script guard rejects missing/empty `test` and `typecheck`.

- `ticket-gates`:
  - `testing` category for API tickets resolves to `test:integration:api`.
  - verify command list includes `typecheck` + resolved slice test command, deduped and runnable.

- `super-ralph-wiring`:
  - prompt props receive API-focused commands when ticket is `API-*` + `testing`.

- `generated-workflow-gates`:
  - generated `PACKAGE_SCRIPTS` required gate keys match root `package.json`.

- `patch-regression`:
  - patch contains updated hunks for gate-resolution/wiring files touched by this ticket.

### Integration tests
- `workflow-gate-policy.integration`:
  - package script contract for gate-required scripts is explicit and non-empty.
  - category-to-command resolution for `API-005` (`testing`) includes `typecheck + test:integration:api`.
  - generated workflow required gate script keys do not drift from root scripts.

## Risks and mitigations
1. **Risk:** `testing` category may refer to non-API ticket streams in future.
   **Mitigation:** keep fallback behavior explicit; scope API-specific override to identifiable ticket context (ticket ID/category pairing), and document fallback semantics in tests.

2. **Risk:** generated workflow drift reappears after script edits.
   **Mitigation:** add explicit drift assertions and treat regeneration as required in the ticket workflow.

3. **Risk:** editing `node_modules/super-ralph` without patch refresh causes non-reproducible behavior.
   **Mitigation:** update `patches/super-ralph-codex-schema.patch` in same slice and keep patch-regression tests green.

4. **Risk:** stricter script assertions may be brittle to harmless command formatting changes.
   **Mitigation:** assert required command intent/keys first, keep exact-string checks to high-signal keys only.

## How to verify against acceptance criteria

Acceptance criteria mapping:
- Root enforceable commands exist and are non-empty:
  - `workflow-gate-policy.integration` script contract assertions.
- Workflow checks are wired to run `typecheck + relevant tests` per slice:
  - `ticket-gates` unit tests + `super-ralph-wiring` unit tests + `workflow-gate-policy.integration`.
- API/data slice validation is enforceable for API-series testing tickets:
  - `ticket-gates` + `workflow-gate-policy.integration` assertions for `API-005`.
- Generated workflow remains aligned with root scripts:
  - `generated-workflow-gates` + integration drift check.

Verification commands:
- `bun test tests/unit/workflow/gate-config.test.ts`
- `bun test tests/unit/workflow/ticket-gates.test.ts`
- `bun test tests/unit/workflow/super-ralph-wiring.test.tsx`
- `bun test tests/unit/workflow/generated-workflow-gates.test.ts`
- `bun test tests/unit/workflow/patch-regression.test.ts`
- `bun test tests/integration/workflow-gate-policy.integration.test.ts`
- `bun run typecheck`
