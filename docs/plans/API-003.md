# API-003 Plan: Explicit Approval and Safety Enforcement at API Boundaries (TDD First)

## Overview of the approach
`docs/design.spec.md:45`, `docs/design.spec.md:46`, and `docs/design.spec.md:64` require explicit approval before any outbound execution or external sync. The implementation approach is to lock this behavior at two layers:
1. Core lifecycle guards (`local_only/draft -> pending_approval -> executed`) that block direct execution paths.
2. API boundary guarantees (input validation, normalized error mapping, HTTP status/sanitized response behavior) so callers cannot bypass or obscure those guards.

Because current research shows substantial enforcement already present, this ticket is executed as a red-green hardening pass: add/extend failing tests first, then only implement gaps exposed by those tests.

## TDD step order (tests before implementation)
1. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `approval.approveOutboundAction` rejects whitespace-only `entityId`.
   **Implement:** `src/api/workflows/routes.ts` -> enforce `parseNonEmptyStringField(...)` usage in `validateApproveOutboundActionRequest(...)`.

2. **Test:** `tests/unit/api/workflows/routes.test.ts` -> approval routes reject whitespace-only `actor.id`.
   **Implement:** `src/api/workflows/routes.ts` -> enforce non-empty actor IDs in `parseActorField(...)`.

3. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `approval.requestEventSync` rejects blank `eventId`.
   **Implement:** `src/api/workflows/routes.ts` -> enforce non-empty `eventId` in `validateRequestEventSyncRequest(...)`.

4. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `approval.requestOutboundDraftExecution` rejects blank `draftId`.
   **Implement:** `src/api/workflows/routes.ts` -> enforce non-empty `draftId` in `validateRequestOutboundDraftExecutionRequest(...)`.

5. **Test:** `tests/unit/core/services/event-service.test.ts` -> `requestEventSync` returns conflict unless event state is `local_only`.
   **Implement:** `src/core/services/event-service.ts` -> keep/introduce sync-state precondition in `requestEventSync(...)` before any notification/audit writes.

6. **Test:** `tests/unit/core/services/outbound-draft-service.test.ts` -> `requestOutboundDraftExecution` returns conflict unless draft status is `draft`.
   **Implement:** `src/core/services/outbound-draft-service.ts` -> keep/introduce status precondition in `requestOutboundDraftExecution(...)` before notification/audit writes.

7. **Test:** `tests/unit/core/services/approval-service.test.ts` -> `approveOutboundAction` fails when `approved !== true` and never calls `outboundActionPort.execute`.
   **Implement:** `src/core/services/approval-service.ts` -> enforce explicit-approval gate in `approveOutboundAction(...)`.

8. **Test:** `tests/unit/core/services/approval-service.test.ts` -> non-user approvers are forbidden and cannot execute outbound action.
   **Implement:** `src/core/services/approval-service.ts` -> enforce `assertApprovalActorAuthorized(actor)` in `approveOutboundAction(...)`.

9. **Test:** `tests/unit/core/services/approval-service.test.ts` -> event sync approval requires existing event in `pending_approval`; otherwise return `not_found`/`conflict`.
   **Implement:** `src/core/services/approval-service.ts` -> enforce event existence/state preconditions before calling `outboundActionPort.execute`.

10. **Test:** `tests/unit/core/services/approval-service.test.ts` -> outbound draft approval requires existing draft in `pending_approval`; otherwise return `not_found`/`conflict`.
    **Implement:** `src/core/services/approval-service.ts` -> enforce outbound draft existence/state preconditions before execution.

11. **Test:** `tests/unit/core/services/approval-service.test.ts` -> second approval attempt for already executed event/draft returns conflict and does not re-execute.
    **Implement:** `src/core/services/approval-service.ts` -> classify non-`pending_approval` duplicate approval attempts as `code: "conflict"`.

12. **Test:** `tests/unit/api/workflows/errors.test.ts` -> map service/domain codes to API codes/statuses (`validation=400`, `forbidden=403`, `conflict=409`, `not_found=404`).
    **Implement:** `src/api/workflows/errors.ts` -> enforce mapping in `toWorkflowApiError(route, error)` and `WorkflowApiError` metadata.

13. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `wrapHandler` preserves route/code/status metadata for fail/throw/defect paths.
    **Implement:** `src/api/workflows/workflow-api.ts` -> keep/adjust `wrapHandler(...)` to normalize all errors through `toWorkflowApiError(...)`.

14. **Test:** `tests/unit/api/workflows/http-dispatch.test.ts` -> dispatcher returns 400/403/404/409 and strips internal fields (`cause`, `_tag`) from client body.
    **Implement:** `src/api/workflows/http-dispatch.ts` -> enforce `toHttpStatus(...)` + sanitized `toClientErrorBody(...)`.

15. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> event flow requires `requestEventSync` first; approval rejection keeps event `pending_approval`; duplicate approval conflicts with no extra execution.
    **Implement:** adjust `src/core/services/event-service.ts`, `src/core/services/approval-service.ts`, and `src/core/app/core-platform.ts` only if integration exposes gaps.

16. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> outbound draft flow requires `requestOutboundDraftExecution` first; rejection keeps `pending_approval`; duplicate approval conflicts with no extra execution.
    **Implement:** adjust `src/core/services/outbound-draft-service.ts`, `src/core/services/approval-service.ts`, and `src/core/app/core-platform.ts` only if integration exposes gaps.

17. **Integration Test:** `tests/integration/workflow-api-http.integration.test.ts` -> approval endpoints return expected 400/403/409 statuses and sanitized error body shape.
    **Implement:** adjust `src/api/workflows/routes.ts`, `src/api/workflows/errors.ts`, `src/api/workflows/http-dispatch.ts` only if needed.

18. **Integration Test:** `tests/integration/api-data.integration.test.ts` -> repeated approval-request operations do not create duplicate pending transitions/audit writes.
    **Implement:** refine guard ordering in `src/core/services/event-service.ts` and `src/core/services/outbound-draft-service.ts` only if duplicates appear.

## Files to create/modify (with specific function signatures)

### Create
- None expected for baseline implementation; work is concentrated in existing API/core files.

### Modify (implementation)
- `src/core/services/approval-service.ts`
  - `export const assertApprovalActorAuthorized(actor: ActorRef): Effect.Effect<void, ApprovalServiceError>`
  - `export const approveOutboundAction(repository: CoreRepository, outboundActionPort: OutboundActionPort, input: ApproveOutboundActionInput): Effect.Effect<ApprovalResult, ApprovalServiceError>`
  - `export class ApprovalServiceError extends Data.TaggedError("ApprovalServiceError")<{ message: string; code?: "forbidden" | "conflict" | "not_found" | "invalid_request" }>`

- `src/core/services/event-service.ts`
  - `export const requestEventSync(repository: CoreRepository, eventId: string, actor: ActorRef, at?: Date): Effect.Effect<{ event: Event; notification: Notification }, EventServiceError>`
  - `export class EventServiceError extends Data.TaggedError("EventServiceError")<{ message: string; code?: "conflict" | "not_found" | "invalid_request" }>`

- `src/core/services/outbound-draft-service.ts`
  - `export const requestOutboundDraftExecution(repository: CoreRepository, draftId: string, actor: ActorRef, at?: Date): Effect.Effect<{ draft: OutboundDraft; notification: Notification }, OutboundDraftServiceError>`
  - `export class OutboundDraftServiceError extends Data.TaggedError("OutboundDraftServiceError")<{ message: string; code?: "conflict" | "not_found" | "invalid_request" }>`

- `src/core/app/core-platform.ts`
  - `const withMutationBoundary = <A, E>(effect: Effect.Effect<A, E>): Effect.Effect<A, E>`
  - `approveOutboundAction: (input: ApproveOutboundActionInput) => ReturnType<typeof approveOutboundAction>`
  - `requestEventSync: (eventId: string, actor: ActorRef, at?: Date) => ReturnType<typeof requestEventSync>`
  - `requestOutboundDraftExecution: (draftId: string, actor: ActorRef, at?: Date) => ReturnType<typeof requestOutboundDraftExecution>`

- `src/api/workflows/routes.ts`
  - `function parseNonEmptyStringField(route: WorkflowRouteKey, source: Record<string, unknown>, field: string): RouteValidation<string>`
  - `function parseActorField(route: WorkflowRouteKey, source: Record<string, unknown>, field: string): RouteValidation<ActorRefPayload>`
  - `const validateRequestEventSyncRequest: RouteValidator<RequestEventSyncRequest>`
  - `const validateRequestOutboundDraftExecutionRequest: RouteValidator<RequestOutboundDraftExecutionRequest>`
  - `const validateApproveOutboundActionRequest: RouteValidator<ApproveOutboundActionRequest>`

- `src/api/workflows/errors.ts`
  - `export type WorkflowApiErrorCode = "validation" | "forbidden" | "conflict" | "not_found" | "unknown"`
  - `export class WorkflowApiError extends Data.TaggedError("WorkflowApiError")<{ route: WorkflowRouteKey; message: string; code: WorkflowApiErrorCode; statusCode: number; cause?: unknown }>`
  - `export const toWorkflowApiError(route: WorkflowRouteKey, error: unknown): WorkflowApiError`

- `src/api/workflows/workflow-api.ts`
  - `export const wrapHandler = <Input, Output>(route: WorkflowRouteKey, handler: (input: Input) => Effect.Effect<Output, unknown>) => (input: Input) => Effect.Effect<Output, WorkflowApiError>`

- `src/api/workflows/http-dispatch.ts`
  - `const toHttpStatus(error: WorkflowApiError): number`
  - `export const makeWorkflowHttpDispatcher = (routes: ReadonlyArray<WorkflowRouteDefinition>) => (request: WorkflowHttpRequest) => Effect.Effect<WorkflowHttpResponse, never>`

### Modify (tests)
- `tests/unit/core/services/approval-service.test.ts`
- `tests/unit/core/services/event-service.test.ts`
- `tests/unit/core/services/outbound-draft-service.test.ts`
- `tests/unit/api/workflows/routes.test.ts`
- `tests/unit/api/workflows/errors.test.ts`
- `tests/unit/api/workflows/workflow-api.test.ts`
- `tests/unit/api/workflows/http-dispatch.test.ts`
- `tests/integration/workflow-api.integration.test.ts`
- `tests/integration/workflow-api-http.integration.test.ts`
- `tests/integration/api-data.integration.test.ts`

## Tests to write (unit + integration)

### Unit tests
- `tests/unit/api/workflows/routes.test.ts`
  - approval request IDs (`eventId`, `draftId`, `entityId`) reject empty/whitespace values.
  - approval actor rejects empty/whitespace `actor.id`.
- `tests/unit/core/services/event-service.test.ts`
  - event sync request from non-`local_only` states returns `conflict`.
- `tests/unit/core/services/outbound-draft-service.test.ts`
  - draft execution request from non-`draft` states returns `conflict`.
- `tests/unit/core/services/approval-service.test.ts`
  - `approved=false` returns `invalid_request` and no execution side effect.
  - non-user actors return `forbidden`.
  - missing event/draft returns `not_found`.
  - non-pending event/draft returns `conflict`.
  - duplicate approvals do not re-execute side effects.
- `tests/unit/api/workflows/errors.test.ts`
  - maps `invalid_request -> validation/400`, `forbidden -> 403`, `conflict -> 409`, `not_found -> 404`.
- `tests/unit/api/workflows/workflow-api.test.ts`
  - wrapper preserves `route`, `code`, and `statusCode` on fail/throw/defect.
- `tests/unit/api/workflows/http-dispatch.test.ts`
  - dispatcher status and sanitized error body behavior for validation/forbidden/conflict/not-found.

### Integration tests
- `tests/integration/workflow-api.integration.test.ts`
  - event approval path: `local_only -> pending_approval -> synced` only after explicit approval.
  - event rejection path leaves `pending_approval` and does not execute outbound action.
  - outbound draft path: `draft -> pending_approval -> executed` only after explicit approval.
  - outbound draft rejection path leaves `pending_approval`.
  - second approval attempts return `conflict` with no second execution.
- `tests/integration/workflow-api-http.integration.test.ts`
  - HTTP approval endpoints return expected `400`, `403`, `409` codes with sanitized payload shape.
- `tests/integration/api-data.integration.test.ts`
  - repeated sync/execution request attempts do not create duplicate `pending_approval` transitions or duplicate notifications.

## Risks and mitigations
1. **Risk:** Existing behavior already passes; hidden regressions may be masked by broad assertions.
   **Mitigation:** Add narrow assertions for state transitions, execution call counts, and error metadata fields (`code`, `statusCode`, `route`).

2. **Risk:** Inconsistent error classification between core services and API mapping.
   **Mitigation:** Keep one mapping contract (`invalid_request`, `forbidden`, `conflict`, `not_found`) and assert it directly in `errors.test.ts` and HTTP dispatch tests.

3. **Risk:** Duplicate approval requests could accidentally emit extra notifications/audit entries.
   **Mitigation:** Add integration checks for transition counts and enforce state preconditions before writes.

4. **Risk:** Transaction boundaries may drift, causing partial writes on failures.
   **Mitigation:** Keep approval/event/outbound mutators routed via `withMutationBoundary(...)` and validate rollback behavior in service tests.

5. **Risk:** Future route changes may reintroduce unsafe validation gaps.
   **Mitigation:** Keep route tests focused on exact approval fields and run them in CI as a dedicated API boundary slice.

## How to verify against acceptance criteria
Acceptance mapping:
1. `docs/design.spec.md:45` (Local event -> pending approval -> external sync on explicit approval)
   - Verify request path only sets `pending_approval`.
   - Verify sync execution only occurs inside `approveOutboundAction(... approved: true ...)`.

2. `docs/design.spec.md:46` (Outbound draft -> explicit approval -> execute)
   - Verify request path only sets `pending_approval`.
   - Verify execution requires explicit approval and pending state.

3. `docs/design.spec.md:64` (Explicit approval for outbound actions)
   - Verify `approved=false` is rejected and unauthorized actors are forbidden.

Run verification commands:
- `bun test tests/unit/core/services/approval-service.test.ts`
- `bun test tests/unit/core/services/event-service.test.ts`
- `bun test tests/unit/core/services/outbound-draft-service.test.ts`
- `bun test tests/unit/api/workflows/routes.test.ts`
- `bun test tests/unit/api/workflows/errors.test.ts`
- `bun test tests/unit/api/workflows/workflow-api.test.ts`
- `bun test tests/unit/api/workflows/http-dispatch.test.ts`
- `bun test tests/integration/workflow-api.integration.test.ts`
- `bun test tests/integration/workflow-api-http.integration.test.ts`
- `bun test tests/integration/api-data.integration.test.ts`
- `bun run test:integration:api`
- `bun run typecheck`
