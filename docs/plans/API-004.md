# API-004 Plan: Add API/Data Tests for Core Behavior and Edge Cases (TDD First)

## Overview of the approach
This ticket is a test-hardening slice focused on API/data behavior before any UI work (`docs/engineering.choices.md:19`). The repository already has broad happy-path coverage; this plan adds missing edge-case assertions for empty input validation, permission/auth failures, idempotency/conflict behavior, retry/fix failure handling, and AI recovery failure handling.

Execution model:
1. Add one failing test at a time.
2. Implement the smallest production change needed to pass that test.
3. Keep each step atomic (one route/function/test per step).
4. Finish with targeted integration runs (`api`, `workflow`, `db`) and `typecheck`.

## TDD step order (tests before implementation)
1. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `capture.entry` rejects whitespace-only `content`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateCaptureEntryRequest(...)` to use `parseNonEmptyStringField(...)` for `content`.

2. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `signal.ingest` rejects whitespace-only `source`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateIngestSignalRequest(...)` to use `parseNonEmptyStringField(...)` for `source`.

3. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `signal.ingest` rejects whitespace-only `payload`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateIngestSignalRequest(...)` to use `parseNonEmptyStringField(...)` for `payload`.

4. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `job.create` rejects whitespace-only `name`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateCreateJobRequest(...)` to use `parseNonEmptyStringField(...)` for `name`.

5. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `job.retry` rejects whitespace-only `jobId`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateRetryJobRequest(...)` to use `parseNonEmptyStringField(...)` for `jobId`.

6. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `checkpoint.keep` rejects whitespace-only `checkpointId`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateKeepCheckpointRequest(...)` to use `parseNonEmptyStringField(...)` for `checkpointId`.

7. **Test:** `tests/unit/api/workflows/routes.test.ts` -> `checkpoint.recover` rejects whitespace-only `checkpointId`.
   **Implement:** `src/api/workflows/routes.ts` -> update `validateRecoverCheckpointRequest(...)` to use `parseNonEmptyStringField(...)` for `checkpointId`.

8. **Test:** `tests/unit/api/workflows/errors.test.ts` -> `JobServiceError` (`not_found` / `invalid_request`) maps to `404` / `400`.
   **Implement:** `src/core/services/job-service.ts` -> add `code?: "not_found" | "invalid_request"` to `JobServiceError` and set `loadJob(...)` + `listJobRunHistory(...)` validation failures accordingly.

9. **Test:** `tests/unit/api/workflows/errors.test.ts` -> `CheckpointServiceError` (`not_found` / `conflict` / `invalid_request`) maps to `404` / `409` / `400`.
   **Implement:** `src/core/services/checkpoint-service.ts` -> add `code?: "not_found" | "conflict" | "invalid_request"` to `CheckpointServiceError` and set `loadCheckpoint(...)`, `ensureCanKeep(...)`, `ensureCanRecover(...)`, and create-validation mapping accordingly.

10. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `retryJob` and checkpoint handlers preserve mapped route/code/status metadata from service failures.
    **Implement:** `src/api/workflows/workflow-api.ts` only if needed to preserve `wrapHandler(...)` metadata behavior.

11. **Integration Test:** `tests/integration/workflow-api-http.integration.test.ts` -> empty-input validation returns sanitized `400` for `capture.entry` and `signal.ingest`.
    **Implement:** `src/api/workflows/routes.ts` and/or error mapping only if the response contract is not stable.

12. **Integration Test:** `tests/integration/workflow-api-http.integration.test.ts` -> auth/permission failure returns sanitized `403` for outbound-draft approval actor `kind !== "user"`.
    **Implement:** `src/core/services/approval-service.ts` only if actor checks are bypassed on outbound-draft branch.

13. **Integration Test:** `tests/integration/workflow-api-http.integration.test.ts` -> retry/recovery missing-resource cases return sanitized `404` (`job.retry`, `checkpoint.keep`).
    **Implement:** `src/core/services/job-service.ts` and `src/core/services/checkpoint-service.ts` error code tagging (if not already passing).

14. **Integration Test:** `tests/integration/api-data.integration.test.ts` -> duplicate event approval conflicts without extra execution or extra terminal audit transitions.
    **Implement:** `src/core/services/approval-service.ts` guard ordering if duplicate approvals still write side effects.

15. **Integration Test:** `tests/integration/api-data.integration.test.ts` -> duplicate outbound-draft approval conflicts without extra execution IDs/transitions.
    **Implement:** `src/core/services/approval-service.ts` duplicate-execution guard for `outbound_draft` path if needed.

16. **Integration Test:** `tests/integration/workflow-automation.integration.test.ts` -> retry/fix failure path (`retryJob` on missing job) is deterministic and side-effect free.
    **Implement:** `src/core/services/job-service.ts` load-first failure behavior/code tagging if side effects appear.

17. **Integration Test:** `tests/integration/workflow-automation.integration.test.ts` -> AI recovery failure path (`recoverCheckpoint` invalid transition/missing snapshot) leaves checkpoint state consistent.
    **Implement:** `src/core/services/checkpoint-service.ts` transition gating and error tagging if state drift appears.

18. **Integration Test:** `tests/integration/database-core-platform.integration.test.ts` -> sqlite relation-integrity trigger failure is surfaced (e.g., deleting referenced entities) and data remains intact.
    **Implement:** `src/core/repositories/sqlite/sqlite-core-repository.ts` error normalization only if trigger failures are obscured.

19. **Integration Test:** `tests/integration/database-core-platform.integration.test.ts` -> sqlite transaction rollback for retry/fix write failure (e.g., failing `appendAuditTransition` during `recordJobRun`) keeps job/history consistent.
    **Implement:** `src/core/app/core-platform.ts` mutation boundary coverage and/or service ordering only if partial writes remain.

20. **Integration Test:** `tests/integration/database-core-platform.integration.test.ts` -> sqlite transaction rollback for AI recovery write failure (`recoverCheckpoint`) prevents partial restore.
    **Implement:** `src/core/services/checkpoint-service.ts` recover sequencing only if partial restore leaks through transactions.

## Files to create/modify (with specific function signatures)

### Create
- None expected. Work is concentrated in existing test and service/router files.

### Modify (tests)
- `tests/unit/api/workflows/routes.test.ts`
- `tests/unit/api/workflows/errors.test.ts`
- `tests/unit/api/workflows/workflow-api.test.ts`
- `tests/integration/workflow-api-http.integration.test.ts`
- `tests/integration/api-data.integration.test.ts`
- `tests/integration/workflow-automation.integration.test.ts`
- `tests/integration/database-core-platform.integration.test.ts`

### Modify (implementation, only if tests expose gaps)
- `src/api/workflows/routes.ts`
  - `function parseNonEmptyStringField(route: WorkflowRouteKey, source: Record<string, unknown>, field: string): RouteValidation<string>`
  - `const validateCaptureEntryRequest: RouteValidator<CaptureEntryRequest>`
  - `const validateIngestSignalRequest: RouteValidator<IngestSignalRequest>`
  - `const validateCreateJobRequest: RouteValidator<CreateJobRequest>`
  - `const validateRetryJobRequest: RouteValidator<RetryJobRequest>`
  - `const validateKeepCheckpointRequest: RouteValidator<KeepCheckpointRequest>`
  - `const validateRecoverCheckpointRequest: RouteValidator<RecoverCheckpointRequest>`

- `src/core/services/job-service.ts`
  - `export class JobServiceError extends Data.TaggedError("JobServiceError")<{ message: string; code?: "not_found" | "invalid_request" }>`
  - `const loadJob(repository: CoreRepository, jobId: string): Effect.Effect<Job, JobServiceError>`
  - `export const listJobRunHistory(repository: CoreRepository, input: { jobId: string; limit?: number; beforeAt?: Date; }): Effect.Effect<ReadonlyArray<JobRunHistoryRecord>, JobServiceError>`

- `src/core/services/checkpoint-service.ts`
  - `export class CheckpointServiceError extends Data.TaggedError("CheckpointServiceError")<{ message: string; code?: "not_found" | "conflict" | "invalid_request" }>`
  - `const loadCheckpoint(repository: CoreRepository, checkpointId: string): Effect.Effect<Checkpoint, CheckpointServiceError>`
  - `const ensureCanKeep(checkpoint: Checkpoint): Effect.Effect<void, CheckpointServiceError>`
  - `const ensureCanRecover(checkpoint: Checkpoint): Effect.Effect<void, CheckpointServiceError>`
  - `export const createWorkflowCheckpoint(repository: CoreRepository, input: CreateWorkflowCheckpointInput): Effect.Effect<Checkpoint, CheckpointServiceError>`
  - `export const recoverCheckpoint(repository: CoreRepository, checkpointId: string, actor: ActorRef, at?: Date): Effect.Effect<RecoveryResult, CheckpointServiceError>`

- `src/api/workflows/workflow-api.ts`
  - `export const wrapHandler = <Input, Output>(route: WorkflowRouteKey, handler: (input: Input) => Effect.Effect<Output, unknown>) => (input: Input) => Effect.Effect<Output, WorkflowApiError>`

- `src/core/app/core-platform.ts`
  - `const withMutationBoundary = <A, E>(effect: Effect.Effect<A, E>): Effect.Effect<A, E>`

- `src/core/repositories/sqlite/sqlite-core-repository.ts`
  - `const toRepositoryError(message: string, cause: unknown): SqliteCoreRepositoryError`

## Tests to write (unit + integration)

### Unit tests
- Route validation tests for empty/whitespace payloads:
  - `capture.entry.content`
  - `signal.ingest.source`
  - `signal.ingest.payload`
  - `job.create.name`
  - `job.retry.jobId`
  - `checkpoint.keep.checkpointId`
  - `checkpoint.recover.checkpointId`
- Error mapping tests:
  - `JobServiceError.code=not_found` -> `WorkflowApiError.code=not_found`, `statusCode=404`
  - `JobServiceError.code=invalid_request` -> `validation`, `400`
  - `CheckpointServiceError.code=not_found/conflict/invalid_request` -> `404/409/400`
- Wrapper metadata tests:
  - `workflow-api` retry/checkpoint handlers preserve `route`, `code`, and `statusCode`.

### Integration tests
- HTTP dispatch edge tests:
  - empty `capture.entry.content` and empty `signal.ingest.payload` return sanitized `400`.
  - outbound-draft approval by non-user actor returns sanitized `403`.
  - missing retry/checkpoint resources return sanitized `404`.
- API/data idempotency tests:
  - duplicate event approval and duplicate outbound-draft approval do not re-execute and do not append duplicate terminal transitions.
- Retry/fix + recovery failure behavior:
  - missing job retry has no side effects.
  - invalid recovery path keeps checkpoint/data state coherent.
- SQLite data integrity + rollback:
  - relation-trigger failures are surfaced and state remains intact.
  - forced write failures inside `recordJobRun` and `recoverCheckpoint` roll back partial mutations.

## Risks and mitigations
1. **Risk:** New edge tests assert stricter behavior than current contracts.
   **Mitigation:** Keep each change atomic and update only the specific validator/error contract required by the failing test.

2. **Risk:** Error-code tagging introduces broad assertion updates.
   **Mitigation:** Add mapping tests first (`errors.test.ts`) and only tag codes for retry/checkpoint paths covered by this ticket.

3. **Risk:** SQLite failure-path tests can be flaky if failure injection is nondeterministic.
   **Mitigation:** Use deterministic repository wrappers (single targeted failure conditions), assert exact side effects before/after.

4. **Risk:** Tightening route validation could reject previously accepted payloads.
   **Mitigation:** Limit non-empty enforcement to required fields; preserve existing optional field behavior and ISO date coercion tests.

5. **Risk:** Partial-write rollback assertions may differ between in-memory and sqlite repositories.
   **Mitigation:** Keep rollback invariants backend-specific in tests (service-level for in-memory, transaction-level for sqlite).

## How to verify against acceptance criteria

Acceptance criteria mapping:
- **Happy path:** existing + updated integration flows in `workflow-api.integration`, `workflow-api-http.integration`, and `api-data.integration`.
- **Empty input validation:** route-unit tests + HTTP integration tests for key routes.
- **Auth/permission failures:** outbound approval forbidden tests (unit/integration/HTTP).
- **Idempotency/conflict handling:** duplicate approval/request tests with side-effect count assertions.
- **Retry/fix flows:** retry success and failure-path tests (unit + integration + DB rollback).
- **AI change recovery:** keep/recover success + failure/rollback tests (unit + integration + DB rollback).

Verification commands:
- `bun test tests/unit/api/workflows/routes.test.ts`
- `bun test tests/unit/api/workflows/errors.test.ts`
- `bun test tests/unit/api/workflows/workflow-api.test.ts`
- `bun test tests/integration/workflow-api-http.integration.test.ts`
- `bun test tests/integration/api-data.integration.test.ts`
- `bun test tests/integration/workflow-automation.integration.test.ts`
- `bun test tests/integration/database-core-platform.integration.test.ts`
- `bun run test:integration:api`
- `bun run test:integration:workflow`
- `bun run test:integration:db`
- `bun run typecheck`
