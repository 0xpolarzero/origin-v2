# API-001 Plan: Scaffold API Workflow Handlers (TDD First)

## Overview
Implement a transport-agnostic API layer under `src/api/workflows/*` that exposes explicit route handlers for all required workflows in `docs/design.spec.md:41-48`, while reusing existing core services through `CorePlatform`.

Approach:
1. Keep business logic in core services; API handlers are thin adapters only.
2. Add explicit route contracts and error mapping for stable API behavior.
3. Add one unit test + one handler implementation step per route.
4. Add integration tests that exercise end-to-end workflow categories through the new API layer.
5. Keep existing core integration tests as regressions to ensure no behavior drift.

Assumption for this ticket: "API layer and handlers" means introducing `src/api/*` route handlers on top of already-implemented in-process core workflows, not re-implementing core domain logic.

## TDD Step Order (tests first, then implementation)
1. **Test:** `tests/unit/api/workflows/errors.test.ts` -> `toWorkflowApiError(route, error)` preserves route key and message.
   **Implement:** `src/api/workflows/errors.ts` -> `WorkflowApiError` + `toWorkflowApiError(route, error)`.
2. **Test:** `tests/unit/api/workflows/routes.test.ts` -> required workflow route keys map to unique, stable `POST` paths.
   **Implement:** `src/api/workflows/contracts.ts` -> `WorkflowRouteKey`; `src/api/workflows/routes.ts` -> `WORKFLOW_ROUTE_PATHS`.
3. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `makeWorkflowApi` returns all required handler functions.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `makeWorkflowApi({ platform })` skeleton returning typed handlers.
4. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `captureEntry` handler delegates to `platform.captureEntry` and maps failure to `WorkflowApiError`.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `captureEntry(input)`.
5. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `suggestEntryAsTask` handler delegates and maps errors.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `suggestEntryAsTask(input)`.
6. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `editEntrySuggestion` handler delegates and maps errors.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `editEntrySuggestion(input)`.
7. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `rejectEntrySuggestion` handler delegates and maps errors.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `rejectEntrySuggestion(input)`.
8. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `acceptEntryAsTask` handler delegates and maps errors.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `acceptEntryAsTask(input)`.
9. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `ingestSignal` handler delegates and maps errors.
   **Implement:** `src/api/workflows/workflow-api.ts` -> `ingestSignal(input)`.
10. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `triageSignal` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `triageSignal(input)`.
11. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `convertSignal` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `convertSignal(input)`.
12. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `completeTask` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `completeTask(input)`.
13. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `deferTask` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `deferTask(input)`.
14. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `rescheduleTask` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `rescheduleTask(input)`.
15. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `requestEventSync` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `requestEventSync(input)`.
16. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `requestOutboundDraftExecution` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `requestOutboundDraftExecution(input)`.
17. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `approveOutboundAction` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `approveOutboundAction(input)`.
18. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `createJob` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `createJob(input)`.
19. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `recordJobRun` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `recordJobRun(input)`.
20. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `inspectJobRun` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `inspectJobRun(input)`.
21. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `retryJob` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `retryJob(input)`.
22. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `createWorkflowCheckpoint` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `createWorkflowCheckpoint(input)`.
23. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `keepCheckpoint` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `keepCheckpoint(input)`.
24. **Test:** `tests/unit/api/workflows/workflow-api.test.ts` -> `recoverCheckpoint` handler delegates and maps errors.
    **Implement:** `src/api/workflows/workflow-api.ts` -> `recoverCheckpoint(input)`.
25. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> capture -> suggestion -> accept/edit/reject path works through API handlers with persisted audit trail.
    **Implement:** minimal request-shape glue in `src/api/workflows/workflow-api.ts` + `src/api/workflows/contracts.ts`.
26. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> signal ingest -> triage -> convert (task/event/note/project/outbound_draft) works through API handlers.
    **Implement:** route input signatures in `src/api/workflows/contracts.ts` for triage/convert requests.
27. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> complete/defer/reschedule planning workflow works through API handlers.
    **Implement:** task route request signatures in `src/api/workflows/contracts.ts`.
28. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> event sync stays pending until explicit approval, then sync executes exactly once.
    **Implement:** event approval route signatures in `src/api/workflows/contracts.ts`.
29. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> outbound draft stays blocked until explicit approval, then executes exactly once.
    **Implement:** outbound approval route signatures in `src/api/workflows/contracts.ts`.
30. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> job run -> inspect -> retry/fix workflow works through API handlers.
    **Implement:** job route request signatures in `src/api/workflows/contracts.ts`.
31. **Integration Test:** `tests/integration/workflow-api.integration.test.ts` -> AI checkpoint inspect/keep/recover workflow remains auditable/reversible through API handlers.
    **Implement:** checkpoint route request signatures in `src/api/workflows/contracts.ts`.
32. **Test:** `bun run test:integration:api` includes API-handler integration coverage.
    **Implement:** `package.json` -> extend `test:integration:api` script to include `tests/integration/workflow-api.integration.test.ts`.

## Files to Create/Modify (with specific function signatures)

### Create
- `src/api/workflows/contracts.ts`
  - `export type WorkflowRouteKey = "capture.entry" | "capture.suggest" | "capture.editSuggestion" | "capture.rejectSuggestion" | "capture.acceptAsTask" | "signal.ingest" | "signal.triage" | "signal.convert" | "planning.completeTask" | "planning.deferTask" | "planning.rescheduleTask" | "approval.requestEventSync" | "approval.requestOutboundDraftExecution" | "approval.approveOutboundAction" | "job.create" | "job.recordRun" | "job.inspectRun" | "job.retry" | "checkpoint.create" | "checkpoint.keep" | "checkpoint.recover"`
  - `export interface WorkflowApi` with one handler per route above.
  - `export interface WorkflowRouteDefinition { key: WorkflowRouteKey; method: "POST"; path: string; handle: (input: unknown) => Effect.Effect<unknown, WorkflowApiError> }`
- `src/api/workflows/errors.ts`
  - `export class WorkflowApiError extends Data.TaggedError("WorkflowApiError")<{ route: WorkflowRouteKey; message: string; cause?: unknown }>`
  - `export const toWorkflowApiError: (route: WorkflowRouteKey, error: unknown) => WorkflowApiError`
- `src/api/workflows/workflow-api.ts`
  - `export interface MakeWorkflowApiOptions { platform: CorePlatform }`
  - `export const makeWorkflowApi: (options: MakeWorkflowApiOptions) => WorkflowApi`
  - `const wrapHandler: <I, O>(route: WorkflowRouteKey, handler: (input: I) => Effect.Effect<O, unknown>) => (input: I) => Effect.Effect<O, WorkflowApiError>`
- `src/api/workflows/routes.ts`
  - `export const WORKFLOW_ROUTE_PATHS: Record<WorkflowRouteKey, string>`
  - `export const makeWorkflowRoutes: (api: WorkflowApi) => ReadonlyArray<WorkflowRouteDefinition>`
- `tests/unit/api/workflows/errors.test.ts`
- `tests/unit/api/workflows/routes.test.ts`
- `tests/unit/api/workflows/workflow-api.test.ts`
- `tests/integration/workflow-api.integration.test.ts`

### Modify
- `package.json`
  - Update `test:integration:api` to include `tests/integration/workflow-api.integration.test.ts`.
- `tests/integration/api-data.integration.test.ts` (optional parity assertions only if needed to avoid duplicate scenario coverage gaps after introducing API layer).

## Tests to Write

### Unit tests
- `tests/unit/api/workflows/errors.test.ts`
  - error mapping tags the correct route and preserves safe message text.
  - non-Error throwables map to deterministic fallback message.
- `tests/unit/api/workflows/routes.test.ts`
  - all required route keys are present.
  - all paths are unique and start with `/api/workflows/`.
  - all methods are `POST` for mutating workflow commands.
- `tests/unit/api/workflows/workflow-api.test.ts`
  - one test per handler verifies delegation to the matching `CorePlatform` method.
  - one failure-path test per handler verifies `WorkflowApiError` mapping.

### Integration tests
- `tests/integration/workflow-api.integration.test.ts`
  - capture -> suggest -> accept/edit/reject path.
  - signal ingestion -> triage -> conversion path.
  - planning adjustments (complete/defer/reschedule).
  - event sync approval gate.
  - outbound draft approval gate.
  - job run/inspect/retry flow.
  - checkpoint keep/recover flow.
- Re-run existing regression suites:
  - `tests/integration/api-data.integration.test.ts`
  - `tests/integration/workflow-automation.integration.test.ts`

## Risks and Mitigations
1. **Risk:** Ambiguity on whether API-001 expects transport routes or in-process methods.
   **Mitigation:** Keep API layer transport-agnostic (`routes.ts` + handlers) so HTTP/IPC can bind later without rework.
2. **Risk:** Behavior drift by duplicating workflow logic in API handlers.
   **Mitigation:** handlers only delegate to `CorePlatform`; no repository/domain writes in `src/api/*`.
3. **Risk:** Error-shape inconsistency across routes.
   **Mitigation:** single `wrapHandler` + `toWorkflowApiError` path with route-key tagging and unit tests.
4. **Risk:** Route contract drift when core signatures evolve.
   **Mitigation:** derive handler inputs from `CorePlatform` signatures where practical and enforce compile-time checks with `typecheck`.
5. **Risk:** Overlapping integration tests become noisy/slow.
   **Mitigation:** keep one primary integration file for API handlers and keep existing integration suites as regression-only.

## How to Verify Against Acceptance Criteria
1. **API layer/handlers scaffold exists**
   - `src/api/workflows/contracts.ts`, `src/api/workflows/workflow-api.ts`, `src/api/workflows/routes.ts` are present and typechecked.
2. **Required workflows are exposed in API handlers**
   - Route key manifest includes capture/triage/conversion, signal ingestion, planning, event/outbound approvals, job run/retry, and checkpoint recovery.
3. **Workflow behavior matches spec**
   - Integration tests in `tests/integration/workflow-api.integration.test.ts` pass for each required workflow category.
4. **Safety boundaries preserved**
   - Approval-gated tests prove outbound actions require explicit approval.
   - Checkpoint tests prove AI-applied changes remain inspectable and reversible.
5. **Quality gates for changed slice pass**
   - `bun test tests/unit/api/workflows/errors.test.ts`
   - `bun test tests/unit/api/workflows/routes.test.ts`
   - `bun test tests/unit/api/workflows/workflow-api.test.ts`
   - `bun run test:integration:api`
   - `bun run test:integration:workflow`
   - `bun run typecheck`
