# API-006 Research Context

## Ticket
- ID: `API-006`
- Title: `Define explicit API and schema contracts for auditability`
- Category: `spec`
- Priority: `medium`
- Description: `Add dedicated contract docs (for routes and persisted schema) so future reviews can perform exact route/schema matching without ambiguity.`

## Relevant Files Field
- No explicit `relevantFiles` payload is present for `API-006` in repository ticket metadata.
- Evidence:
  - `.super-ralph/workflow.db` `category_review.suggested_tickets` contains `API-006` with `id/title/description/category/priority` only.
  - `json_type(value, '$.relevantFiles')` and `json_extract(value, '$.relevantFiles')` are null/empty for `API-006`.

Example query used:

```sql
SELECT
  category_id,
  json_extract(value,'$.id') AS id,
  json_extract(value,'$.title') AS title,
  json_extract(value,'$.category') AS ticket_category,
  json_type(value,'$.relevantFiles') AS relevant_type,
  json_extract(value,'$.relevantFiles') AS relevant_files
FROM category_review, json_each(category_review.suggested_tickets)
WHERE json_extract(value,'$.id')='API-006';
```

## Paths Reviewed

| Path | Summary | Relevance to API-006 |
| --- | --- | --- |
| `.super-ralph/generated/PROMPT.md` | Generated autonomous build prompt with core-first, test/typecheck, and auditability constraints. (Ticket input listed this path twice.) | Defines delivery guardrails for this spec ticket. |
| `README.md` | Repo overview and canonical source-of-truth doc list. | Confirms required docs and current project scope. |
| `docs/design.spec.md` | Product goals/workflows including explicit approval and auditability/recovery requirements. | Root requirement for auditable route+schema contracts. |
| `docs/engineering.choices.md` | Normative engineering constraints, including deterministic core and per-slice validation. | Governs how contract docs should be derived and maintained. |
| `docs/references.md` | Expected external reference submodules under `docs/references/*`. | Reference policy baseline for major implementation decisions. |
| `docs/super-ralph.prompt.md` | Canonical prompt equivalent of generated prompt constraints. | Reinforces same workflow and quality expectations. |
| `docs/context/WF-AUDIT-002.md` | Historical route/schema compliance context and matrix. | Closest predecessor context for explicit route/schema compliance. |
| `docs/plans/WF-AUDIT-002.md` | Original TDD plan that introduced explicit route + run-history schema artifacts. | Historical implementation intent for current contract surfaces. |
| `docs/context/API-002.md` | Canonical schema/migration hardening context. | Background for persisted schema contract boundaries. |
| `docs/context/API-003.md` | API boundary safety/approval enforcement context. | Background for route-level error/validation contract semantics. |
| `docs/context/API-004.md` | API/data edge-case testing context. | Captures test proof points for route/schema behavior. |
| `docs/context/API-005.md` | Workflow gate enforcement context (script/gate contracts). | Format and contract-documentation precedent. |
| `.super-ralph/workflow.db` | Ticket metadata store and run artifacts. | Source of truth for API-006 metadata and missing `relevantFiles`. |
| `src/api/workflows/contracts.ts` | Canonical route-key union, typed request contracts, and route definition shape. | Primary source for API contract documentation content. |
| `src/api/workflows/routes.ts` | `WORKFLOW_ROUTE_PATHS`, payload validators, date coercion policy, and route registration. | Primary source for exact method/path/input contract mapping. |
| `src/api/workflows/workflow-api.ts` | Route-to-core mapping via `wrapHandler` and `toWorkflowApiError`. | Source for handler delegation contract. |
| `src/api/workflows/errors.ts` | Canonical API error code/status mapping (`validation/forbidden/conflict/not_found/unknown`). | Source for route error contract section. |
| `src/api/workflows/http-dispatch.ts` | Transport contract (`method/path/body -> status/body`) with sanitized error payloads. | Source for response/status contract semantics. |
| `src/core/repositories/core-repository.ts` | Persistence contract (`save/get/list/delete`, audit trail, optional job history/listing queries, transaction boundary). | Defines persisted schema access boundary. |
| `src/core/repositories/sqlite/migrations.ts` | Ordered migration manifest (`001`..`005`) + SQL checksums. | Canonical source for persisted schema version contract. |
| `src/core/repositories/sqlite/migration-runner.ts` | `schema_migrations` ledger, sorted apply, checksum mismatch rejection, rollback behavior. | Defines migration/auditability contract at runtime. |
| `src/core/database/migrations/001_core_schema.sql` | Baseline table definitions for core entities + workflow support tables. | Primary source for table/column contract docs. |
| `src/core/database/migrations/002_core_constraints_indexes.sql` | Lifecycle/status triggers, confidence checks, and baseline indexes. | Source for invariant/index contract docs. |
| `src/core/database/migrations/003_relation_integrity.sql` | Relation integrity indexes + polymorphic/entity reference triggers. | Source for cross-entity integrity contract docs. |
| `src/core/database/migrations/004_audit_entity_versions.sql` | `entity_versions` table/index/backfill + insert trigger from `audit_transitions`. | Source for audit-versioning schema contract. |
| `src/core/database/migrations/005_job_run_history.sql` | `job_run_history` table/index/constraints/delete guard + backfill query. | Source for explicit run-history persistence contract. |
| `src/core/repositories/sqlite/sqlite-core-repository.ts` | `TABLE_CONFIGS` mapping from entity types to persisted columns and JSON fields. | Runtime mapping used to validate documented schema contract. |
| `src/core/services/job-service.ts` | Writes and reads `job_run_history` and validates query inputs. | Confirms semantic expectations of run-history schema contract. |
| `src/core/app/core-platform.ts` | Public core facade including `listJobRunHistory`, route-exposed workflow methods. | Source for API-to-core method contract coverage. |
| `tests/unit/api/workflows/routes.test.ts` | Asserts full route manifest/path uniqueness/validator behavior/ISO timestamp rules. | Executable proof for route contract correctness. |
| `tests/unit/api/workflows/workflow-api.test.ts` | Asserts route-to-platform delegation and route-tagged error mapping. | Executable proof for API wrapper contract correctness. |
| `tests/unit/api/workflows/errors.test.ts` | Asserts stable service-error -> API-code/status mapping. | Executable proof for error contract documentation. |
| `tests/unit/api/workflows/http-dispatch.test.ts` | Asserts dispatch statuses (`200/400/403/404/405/500`) and sanitized error bodies. | Executable proof for transport contract documentation. |
| `tests/integration/workflow-api.integration.test.ts` | End-to-end workflow operations through API layer. | Integration proof that route contracts are functionally wired. |
| `tests/integration/workflow-api-http.integration.test.ts` | End-to-end HTTP-dispatch route usage and sanitized error behavior. | Integration proof for real request/response contract behavior. |
| `tests/unit/core/repositories/sqlite-migrations.test.ts` | Asserts migration order, idempotency, and checksum guardrails. | Executable proof for migration contract safety/auditability. |
| `tests/unit/core/repositories/sqlite-schema.test.ts` | Asserts table columns, indexes, trigger failures, entity_versions/job_run_history behavior. | Executable proof for persisted schema contract details. |
| `tests/integration/database-core-platform.integration.test.ts` | Asserts restart durability, job history persistence, audit/version consistency. | Integration proof for persisted schema contract under real workflows. |
| `src/ui/workflows/workflow-surface-client.ts` | UI client directly consumes `WORKFLOW_ROUTE_PATHS` and route keys. | Downstream consumer sensitive to route contract drift. |
| `tests/unit/ui/workflows/workflow-surface-client.test.ts` | Verifies UI client route mapping to current route paths. | Secondary regression proof for route contract stability. |
| `tests/integration/workflow-surfaces.integration.test.ts` | End-to-end surface orchestration over workflow HTTP routes. | Downstream integration signal for route contract stability. |
| `docs/references/` | Not present in this workspace (`No such file or directory`). | External reference repos are unavailable locally for this run. |

## Spec/Guardrail Requirements Extracted for API-006
- `docs/design.spec.md` requires auditable/recoverable AI writes and explicit control on risky/outbound actions.
- `docs/design.spec.md` required workflows depend on stable workflow API operations and durable persisted state.
- `docs/engineering.choices.md` requires deterministic/testable core behavior and per-slice validation.
- `.super-ralph/generated/PROMPT.md` acceptance bar explicitly requires safety and auditability implementation.

## Current Contract Snapshot (What Exists Today)

### 1) API route contract sources
- Canonical route-key type: `src/api/workflows/contracts.ts` (`WorkflowRouteKey`).
- Canonical path map: `src/api/workflows/routes.ts` (`WORKFLOW_ROUTE_PATHS`).
- Route method contract: all route definitions are `POST` in `makeWorkflowRoutes(...)`.
- Input contract source: per-route validators in `routes.ts` (`validate*Request` helpers).
- Error/status contract sources:
  - route-level mapping in `src/api/workflows/errors.ts`.
  - transport-level status/body shaping in `src/api/workflows/http-dispatch.ts`.

Current route key -> path map in source:
- `capture.entry` -> `/api/workflows/capture/entry`
- `capture.suggest` -> `/api/workflows/capture/suggest`
- `capture.editSuggestion` -> `/api/workflows/capture/edit-suggestion`
- `capture.rejectSuggestion` -> `/api/workflows/capture/reject-suggestion`
- `capture.acceptAsTask` -> `/api/workflows/capture/accept-as-task`
- `signal.ingest` -> `/api/workflows/signal/ingest`
- `signal.triage` -> `/api/workflows/signal/triage`
- `signal.convert` -> `/api/workflows/signal/convert`
- `planning.completeTask` -> `/api/workflows/planning/complete-task`
- `planning.deferTask` -> `/api/workflows/planning/defer-task`
- `planning.rescheduleTask` -> `/api/workflows/planning/reschedule-task`
- `approval.requestEventSync` -> `/api/workflows/approval/request-event-sync`
- `approval.requestOutboundDraftExecution` -> `/api/workflows/approval/request-outbound-draft-execution`
- `approval.approveOutboundAction` -> `/api/workflows/approval/approve-outbound-action`
- `job.create` -> `/api/workflows/job/create`
- `job.recordRun` -> `/api/workflows/job/record-run`
- `job.inspectRun` -> `/api/workflows/job/inspect-run`
- `job.list` -> `/api/workflows/job/list`
- `job.listHistory` -> `/api/workflows/job/list-history`
- `job.retry` -> `/api/workflows/job/retry`
- `checkpoint.create` -> `/api/workflows/checkpoint/create`
- `checkpoint.inspect` -> `/api/workflows/checkpoint/inspect`
- `checkpoint.keep` -> `/api/workflows/checkpoint/keep`
- `checkpoint.recover` -> `/api/workflows/checkpoint/recover`
- `activity.list` -> `/api/workflows/activity/list`

### 2) Route validation contract details that matter for docs
- Date parsing accepts `Date` or strict ISO-8601 strings with timezone (`Z` or offset).
- Timezone-less ISO strings are rejected by route validators.
- Non-empty string enforcement is used on high-risk fields (`content`, `source`, `payload`, approval IDs, checkpoint IDs, etc.).
- List endpoints enforce positive integer limits.
- Route validation failures return `WorkflowApiError` with `code: validation`, `statusCode: 400`.

### 3) API error/transport contract details that matter for docs
- Service-domain error code mapping (`errors.ts`):
  - `invalid_request` -> `validation` -> `400`
  - `forbidden` -> `403`
  - `conflict` -> `409`
  - `not_found` -> `404`
  - unknown/other -> `400`
- HTTP dispatch contract (`http-dispatch.ts`):
  - unknown path -> `404`
  - unsupported method -> `405`
  - mapped route failure -> mapped status + sanitized body `{ error, route, message }`
  - dispatch defect -> `500` with generic body (`internal server error`)

### 4) Persisted schema contract sources
- Canonical migration set in order:
  - `001_core_schema`
  - `002_core_constraints_indexes`
  - `003_relation_integrity`
  - `004_audit_entity_versions`
  - `005_job_run_history`
- Migration application contract:
  - `schema_migrations` ledger.
  - deterministic sorted application.
  - checksum mismatch hard-fail.
  - transaction rollback on failed migration.

Current persisted tables across migrations:
- Core/workflow tables: `entry`, `task`, `event`, `project`, `note`, `signal`, `job`, `notification`, `view`, `memory`, `checkpoint`, `outbound_draft`.
- Audit/support tables: `audit_transitions`, `memory_key_index`, `entity_versions`, `job_run_history`.

Key persisted schema invariants currently encoded via triggers:
- Lifecycle/status validity for core entities (`entry`, `task`, `event`, `project`, `signal`, `job`, `notification`, `checkpoint`, `outbound_draft`).
- `memory.confidence` range check.
- Relation integrity checks for `task.project_id`, `task.source_entry_id`, `entry.accepted_task_id`, `outbound_draft.source_signal_id`, `memory_key_index.memory_id`.
- Polymorphic reference integrity checks for:
  - `signal.converted_entity_type/id`
  - `notification.related_entity_type/id`
  - `audit_transitions.entity_type/id`
- `job_run_history` constraints for `job_id`, `outcome`, `actor_kind`, and delete guard.
- `entity_versions` monotonic increment trigger on `audit_transitions` inserts.

Key persisted indexes currently encoded via migrations:
- Audit/job/activity lookup indexes (for example `idx_audit_transitions_entity_at`, `idx_job_run_history_job_id_at`).
- Relation lookup indexes (for example `idx_task_project_id`, `idx_signal_converted_entity`, `idx_notification_related_entity`).
- Version lookup index (`idx_entity_versions_updated_at`).

## Why API-006 Exists (Current Gap)
- Route and persisted schema contracts are explicit in code/tests, but not in dedicated contract documentation files.
- Current reviewer workflow must infer route/schema contracts from TypeScript/SQL/test files.
- There is no single route contract document and no single persisted schema contract document for exact matching.

## Recommended Contract-Doc Targets for API-006
(derived because ticket metadata has no `relevantFiles`)

### New docs to create
- `docs/contracts/workflow-api-routes.md`
  - canonical route-key -> method/path table
  - per-route request payload shape (required vs optional)
  - shared validator rules (dates, actor, IDs, limits)
  - error/status contract and response shape contract
  - source-of-truth pointers to `contracts.ts`, `routes.ts`, `errors.ts`, `http-dispatch.ts`
- `docs/contracts/persisted-schema.md`
  - migration order and checksum/ledger rules
  - canonical table list with columns
  - invariant triggers grouped by concern
  - index list grouped by concern
  - backfill behavior (`entity_versions`, `job_run_history`)
  - source-of-truth pointers to migration SQL + migration runner + schema tests

### Existing files likely to update
- `README.md` (add links to new contract docs)
- potentially `docs/references.md` or `docs/design.spec.md` only if cross-links are needed (not required by ticket text)

## Verification Anchors for Implementation
- Route contract regression:
  - `tests/unit/api/workflows/routes.test.ts`
  - `tests/unit/api/workflows/workflow-api.test.ts`
  - `tests/unit/api/workflows/http-dispatch.test.ts`
  - `tests/integration/workflow-api-http.integration.test.ts`
- Schema contract regression:
  - `tests/unit/core/repositories/sqlite-migrations.test.ts`
  - `tests/unit/core/repositories/sqlite-schema.test.ts`
  - `tests/integration/database-core-platform.integration.test.ts`
- Global quality gate:
  - `bun run typecheck`

## Open Decisions to Resolve During API-006 Implementation
1. Contract doc granularity: one combined contract doc vs two dedicated docs (`routes` + `schema`).
2. Canonical field naming in docs: preserve source snake_case/camelCase differences exactly vs normalize with explicit mapping table.
3. Change management rule: whether contract docs should be explicitly required in future tickets whenever route/schema files change.

## Research Summary
- API-006 has no ticket-provided `relevantFiles`; scope is derived from current route/schema source and test contracts.
- The repository already has explicit route and persisted schema contracts in code/tests.
- The missing piece is dedicated, reviewer-friendly documentation that mirrors these contracts exactly for auditable matching.
