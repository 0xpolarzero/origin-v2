# API-004 Research Context

## Ticket
- ID: `API-004`
- Title: `Add API/data tests for core behavior and edge cases`
- Category: `testing`
- Description: `Create unit/integration tests for happy path plus empty input validation, auth/permission failures, idempotency/conflict handling, retry/fix flows, and AI change recovery before UI integration (docs/engineering.choices.md:19).`

## Relevant Files Field
- No ticket-level `relevantFiles` payload is present for `API-004` in repository ticket metadata.
- Evidence (from `.super-ralph/workflow.db`):
  - `category_review.suggested_tickets` includes `API-004` with `id/title/description/category/priority`.
  - `json_type(ticket, '$.relevantFiles')` resolves to null/empty.

Example query used:

```sql
WITH tickets AS (
  SELECT value AS ticket
  FROM category_review, json_each(category_review.suggested_tickets)
  WHERE category_id='api'
)
SELECT
  json_extract(ticket,'$.id'),
  json_extract(ticket,'$.title'),
  json_type(ticket,'$.relevantFiles'),
  json_extract(ticket,'$.relevantFiles')
FROM tickets
WHERE json_extract(ticket,'$.id')='API-004';
```

## Paths Reviewed

| Path | Summary | Relevance to API-004 |
| --- | --- | --- |
| `.super-ralph/generated/PROMPT.md` | Generated autonomous build prompt (listed twice in ticket inputs). | Confirms core-first and test-before-UI constraints. |
| `.super-ralph/generated/workflow.tsx` | Smithers fallback config and reference-file inputs (`PROMPT`, `README`, `docs`). | Confirms research inputs and workflow metadata context. |
| `.super-ralph/workflow.db` | Stores ticket metadata and prior research records. | Source-of-truth evidence for missing `relevantFiles`. |
| `README.md` | Repo overview and source-of-truth docs list. | Confirms canonical docs to anchor test expectations. |
| `AGENTS.md` | Project rules: core-first, Effect usage, passing tests per atomic commit. | Defines non-negotiable delivery/testing guardrails. |
| `docs/design.spec.md` | Required workflows including approval-gated outbound actions and AI recovery paths. | Primary behavior requirements API/data tests must cover. |
| `docs/engineering.choices.md` | Hard rule: core logic + comprehensive tests before UI (`core-first gate`). | Direct requirement source for this ticket (`:19`). |
| `docs/references.md` | Lists expected external submodules under `docs/references/*`. | Reference policy baseline (submodules unavailable in this workspace). |
| `docs/super-ralph.prompt.md` | Canonical autonomous prompt copy of constraints. | Reinforces testing and safety requirements. |
| `docs/test-suite-findings.md` | Historical testing gap analysis from earlier project phase. | Context only; partly stale relative to current test suite maturity. |
| `docs/context/API-003.md` | Prior API boundary enforcement context and test map. | Direct predecessor for approval/error/conflict coverage. |
| `docs/context/CORE-REV-006.md` | Prior edge-case testing context (empty/auth/conflict/approval). | Baseline overlap with API-004 testing goals. |
| `src/core/app/core-platform.ts` | Facade that wraps mutating operations in `repository.withTransaction(...)`. | Defines execution boundary for integration tests. |
| `src/api/workflows/contracts.ts` | Route-key surface and request contract types. | Defines API test matrix scope. |
| `src/api/workflows/routes.ts` | Route validators, coercion, and handler wiring. | Primary empty-input and payload-validation surface. |
| `src/api/workflows/workflow-api.ts` | API wrapper delegating to platform and mapping failures. | Core of API error-path unit tests. |
| `src/api/workflows/errors.ts` | Maps service errors to API code/status (`400/403/404/409`). | Core of permission/conflict/not-found test assertions. |
| `src/api/workflows/http-dispatch.ts` | HTTP dispatcher with sanitized error bodies and method/path handling. | Integration/unit surface for API transport status mapping. |
| `src/core/services/event-service.ts` | `requestEventSync` conflict guards + rollback behavior. | Idempotency/conflict and failure rollback coverage source. |
| `src/core/services/outbound-draft-service.ts` | Approval-request transition and rollback logic for drafts. | Conflict/idempotency and failure rollback test target. |
| `src/core/services/approval-service.ts` | Explicit approval gate, user-only permission checks, conflict/not_found handling, execution rollback. | Auth/permission, conflict, and explicit-approval behavior source. |
| `src/core/services/job-service.ts` | Job retry/inspection/history logic with validation. | Retry/fix coverage source. |
| `src/core/services/checkpoint-service.ts` | Checkpoint create/keep/recover logic and recovery semantics. | AI change recovery coverage source. |
| `src/core/services/entry-service.ts` | Capture/suggestion/reject/accept flows over entries/tasks. | Happy-path + validation baseline for API/data flows. |
| `src/core/services/signal-service.ts` | Signal ingest/triage/convert workflows with target-type branching. | Happy-path + conversion conflict/precondition coverage. |
| `src/core/domain/common.ts` | Shared `validateNonEmpty` and domain error primitive. | Empty-input domain validation foundation. |
| `src/core/domain/entry.ts` | `createEntry` enforces non-empty content. | Empty-input coverage target for capture path. |
| `src/core/domain/checkpoint.ts` | `createCheckpoint` enforces non-empty `name` and `rollbackTarget`. | Empty-input coverage target for recovery workflow. |
| `src/core/repositories/core-repository.ts` | Repository contract including transaction boundary and history query. | Defines persistence abstractions for API/data integration tests. |
| `src/core/repositories/in-memory-core-repository.ts` | In-memory implementation + filtered `listJobRunHistory`. | Deterministic unit/integration fixture behavior. |
| `src/core/repositories/file-core-repository.ts` | Snapshot persistence/load behavior. | Restart/replay tests for pending approval and local-first durability. |
| `src/core/repositories/sqlite/sqlite-core-repository.ts` | SQLite-backed persistence, upserts, filtered job history, transaction/savepoint handling. | Integration/data durability and transactional rollback behavior. |
| `src/core/database/migrations/001_core_schema.sql` | Baseline core schema tables. | Data-level test baseline for API/data flows. |
| `src/core/database/migrations/002_core_constraints_indexes.sql` | Lifecycle check triggers + indexes. | Constraint/error-path expectations for invalid state writes. |
| `src/core/database/migrations/003_relation_integrity.sql` | Relation-integrity triggers across linked entities. | Conflict/integrity failure surfaces for integration coverage. |
| `src/core/database/migrations/004_audit_entity_versions.sql` | Entity version tracking from audit transitions. | Audit/recovery correctness checks. |
| `src/core/database/migrations/005_job_run_history.sql` | Explicit job history table with constraints/backfill. | Retry/fix and history durability coverage. |
| `tests/integration/api-data.integration.test.ts` | API/data end-to-end flows: capture/suggest, approval gating, repeated requests/conflicts, restart replay. | Primary integration coverage for API-004 goals. |
| `tests/integration/workflow-api.integration.test.ts` | API handler integration for capture/signal/planning/approval/retry/recover workflows. | Happy-path + conflict/approval edge behavior via API interface. |
| `tests/integration/workflow-api-http.integration.test.ts` | HTTP dispatch integration including 400/403/404/409 and sanitized error payloads. | API transport-level error behavior coverage. |
| `tests/integration/workflow-automation.integration.test.ts` | Planning loop + retry/fix + checkpoint keep/recover integration. | Retry/fix and AI recovery workflow coverage. |
| `tests/integration/database-core-platform.integration.test.ts` | SQLite-backed durability, restart, approval execution, job history, checkpoint recovery. | Data-layer integration coverage for persistence edge cases. |
| `tests/unit/api/workflows/routes.test.ts` | Route validation/coercion coverage: undefined payloads, malformed fields, whitespace IDs, ISO date parsing. | Empty-input and malformed-request unit coverage. |
| `tests/unit/api/workflows/workflow-api.test.ts` | Delegation and failure-mapping tests for each API handler. | Stable error-mapping guarantees for service failures/defects. |
| `tests/unit/api/workflows/http-dispatch.test.ts` | Dispatch status/body behavior for route/method/errors/defects. | Permission/conflict status mapping and sanitization checks. |
| `tests/unit/api/workflows/errors.test.ts` | Error-code/status normalization tests. | Confirms deterministic mapping for `validation/forbidden/conflict/not_found`. |
| `tests/unit/core/services/event-service.test.ts` | Pending-approval transitions + rollback on notification/audit failures. | Conflict/idempotency + rollback behavior coverage. |
| `tests/unit/core/services/outbound-draft-service.test.ts` | Draft->pending transition, missing/conflict errors, rollback on failures. | Conflict/idempotency + rollback behavior coverage. |
| `tests/unit/core/services/approval-service.test.ts` | Explicit approval, forbidden actor, duplicate approval conflict, rollback and execution-id edge cases. | Auth/permission + conflict + idempotency core coverage. |
| `tests/unit/core/services/job-service.test.ts` | Retry behavior, history ordering/filtering, missing-job failures. | Retry/fix flow unit coverage. |
| `tests/unit/core/services/checkpoint-service.test.ts` | Checkpoint create/keep/recover, invalid transitions, restore failures. | AI change recovery and reversible-write edge coverage. |
| `package.json` | Test and typecheck commands (`test:integration:api`, `test:integration:db`, `typecheck`, etc.). | Execution commands for API-004 validation. |

## Spec/Guardrail Requirements for API-004
- `docs/engineering.choices.md:16-21`: core-first gate requires comprehensive core tests before UI work.
- `docs/engineering.choices.md:24-26`: deterministic/testable core logic and running relevant tests/typecheck per slice.
- `docs/design.spec.md:41-48`: required API/data workflow coverage includes capture, triage, approvals, retries, and recovery.
- `docs/design.spec.md:64-65`: explicit approval + auditable/reversible AI writes must remain enforced and testable.

## Current Coverage Snapshot vs Ticket Requirements

| API-004 requirement | Current coverage | Notes |
| --- | --- | --- |
| Happy path | Broadly covered in `workflow-api.integration`, `api-data.integration`, `database-core-platform.integration`, `workflow-automation.integration`. | End-to-end flows already exist for major workflow categories. |
| Empty input validation | Covered at API route/domain level (`routes.test`, `entry/checkpoint` domain constraints). | Strong unit coverage; limited malformed-input integration coverage across all routes. |
| Auth/permission failures | Covered mainly in approval path (`approval-service.test`, HTTP 403 assertions). | Permission model currently concentrated around outbound approval actor checks. |
| Idempotency/conflict handling | Covered for repeated approvals/requests (`approval-service.test`, `api-data.integration`, `workflow-api.integration`). | Strong for approval paths; less explicit for non-approval mutation duplication. |
| Retry/fix flows | Covered in `job-service.test`, `workflow-automation.integration`, `workflow-api.integration`, DB history durability tests. | Includes retry count/history assertions and restart durability. |
| AI change recovery | Covered in `checkpoint-service.test`, `workflow-automation.integration`, `workflow-api.integration`, `database-core-platform.integration`. | Keep/recover transitions and reversible snapshot behavior are exercised. |

## Gaps/Risks to Target in API-004 Implementation Phase
1. Expand negative integration coverage for malformed/empty payloads beyond currently targeted routes.
2. Add more transport-level assertions for validation consistency across all high-risk routes (not only approvals).
3. Add additional idempotency/conflict cases for repeated non-approval mutations where behavior should be deterministic.
4. Strengthen DB-backed edge tests for relation-trigger failures and conflict-style error surfacing through API boundaries.
5. Ensure retry/fix and recovery paths are asserted both in-memory and sqlite-backed flows when failures occur mid-transaction.

## Proposed File Focus for API-004
- API unit tests:
  - `tests/unit/api/workflows/routes.test.ts`
  - `tests/unit/api/workflows/workflow-api.test.ts`
  - `tests/unit/api/workflows/http-dispatch.test.ts`
  - `tests/unit/api/workflows/errors.test.ts`
- Core service unit tests:
  - `tests/unit/core/services/approval-service.test.ts`
  - `tests/unit/core/services/event-service.test.ts`
  - `tests/unit/core/services/outbound-draft-service.test.ts`
  - `tests/unit/core/services/job-service.test.ts`
  - `tests/unit/core/services/checkpoint-service.test.ts`
- Integration tests:
  - `tests/integration/api-data.integration.test.ts`
  - `tests/integration/workflow-api.integration.test.ts`
  - `tests/integration/workflow-api-http.integration.test.ts`
  - `tests/integration/workflow-automation.integration.test.ts`
  - `tests/integration/database-core-platform.integration.test.ts`
- Supporting implementation surfaces (if test work reveals gaps):
  - `src/api/workflows/routes.ts`
  - `src/api/workflows/workflow-api.ts`
  - `src/api/workflows/http-dispatch.ts`
  - `src/api/workflows/errors.ts`
  - `src/core/services/approval-service.ts`
  - `src/core/services/event-service.ts`
  - `src/core/services/outbound-draft-service.ts`
  - `src/core/services/job-service.ts`
  - `src/core/services/checkpoint-service.ts`
  - `src/core/repositories/sqlite/sqlite-core-repository.ts`

## Suggested Verification Commands (implementation phase)
- `bun test tests/unit/api/workflows/routes.test.ts`
- `bun test tests/unit/api/workflows/workflow-api.test.ts`
- `bun test tests/unit/api/workflows/http-dispatch.test.ts`
- `bun test tests/unit/api/workflows/errors.test.ts`
- `bun test tests/unit/core/services/approval-service.test.ts`
- `bun test tests/unit/core/services/event-service.test.ts`
- `bun test tests/unit/core/services/outbound-draft-service.test.ts`
- `bun test tests/unit/core/services/job-service.test.ts`
- `bun test tests/unit/core/services/checkpoint-service.test.ts`
- `bun run test:integration:api`
- `bun run test:integration:workflow`
- `bun run test:integration:db`
- `bun run typecheck`
