# API-002 Research Context

## Ticket
- ID: `API-002`
- Title: `Implement canonical data schema and migrations for core objects`
- Category: `data`
- Description: Add DB schema + migrations for `Entry`, `Task`, `Event`, `Project`, `Note`, `Signal`, `Job`, `Notification`, `View`, `Memory`, `Checkpoint`, including relations and audit/versioning support required by `docs/design.spec.md:14` and `docs/design.spec.md:65`.

## Relevant Files Field
- No explicit `relevantFiles` payload is present for `API-002` in repository-stored ticket metadata.
- Evidence:
  - `.super-ralph/workflow.db` stores ticket metadata in `category_review.suggested_tickets`.
  - The `API-002` object includes `id/title/description/category/priority` only.
  - `json_extract(value, '$.relevantFiles')` for `API-002` resolves to empty/null.

## Paths Reviewed

| Path | Summary | Relevance to API-002 |
| --- | --- | --- |
| `.super-ralph/generated/PROMPT.md` | Generated autonomous prompt (ticket input listed this path twice). | Defines execution constraints: core-first, Effect-first, test/typecheck, jj checkpoints. |
| `README.md` | Repo overview and source-of-truth doc list. | Confirms required canonical docs to interpret schema scope. |
| `docs/design.spec.md` | Core objects list and safety boundaries (`auditable, reversible AI writes`). | Primary requirement source for entities, auditability, and recovery expectations. |
| `docs/engineering.choices.md` | Normative delivery guardrails and deterministic-core requirements. | Constrains migration/repository design and testing rigor. |
| `docs/references.md` | Expected external references under `docs/references/*`. | Reference policy baseline for major implementation decisions. |
| `docs/super-ralph.prompt.md` | Canonical prompt, same constraints as generated prompt. | Reinforces delivery/quality behavior for this ticket. |
| `.super-ralph/generated/workflow.tsx` | Smithers workflow wiring and fallback config. | Confirms research task framing and reference path inputs. |
| `.super-ralph/workflow.db` | Workflow outputs and ticket metadata store. | Source of truth for `API-002` metadata and missing `relevantFiles` evidence. |
| `docs/plans/CORE-REV-003.md` | Original TDD plan for app-level schema/migrations and SQLite repository. | Direct predecessor plan for this ticketâ€™s scope. |
| `docs/context/CORE-REV-003.md` | Prior research mapping required entities/constraints and storage gaps. | Baseline context for API-002 overlap and progress check. |
| `docs/context/CORE-REV-003-review-fix-tdd.md` | Review-fix notes for transaction boundary, migration safety, and index hardening. | Captures post-implementation risk fixes relevant to data layer correctness. |
| `src/core/database/migrations/001_core_schema.sql` | Baseline schema tables for all core entities + `outbound_draft` + audit/index auxiliary tables. | Primary implementation artifact for canonical data schema coverage. |
| `src/core/database/migrations/002_core_constraints_indexes.sql` | State validation triggers, confidence range checks, and core indexes. | Adds lifecycle integrity and query-path performance scaffolding. |
| `src/core/repositories/sqlite/migrations.ts` | Declares ordered migration set + SHA256 checksums. | Defines versioned migration manifest for deterministic upgrades. |
| `src/core/repositories/sqlite/migration-runner.ts` | Creates `schema_migrations`, applies pending migrations transactionally, enforces checksum consistency/idempotency. | Implements migration versioning and safety guarantees. |
| `src/core/repositories/sqlite/sqlite-core-repository.ts` | Entity-to-table mapping, JSON encoding/decoding, audit append/list, transaction wrapper (`BEGIN IMMEDIATE`). | Runtime persistence layer using canonical schema. |
| `src/core/repositories/core-repository.ts` | Core persistence/audit contract with transaction boundary. | Contract that schema-backed repository must satisfy. |
| `src/core/domain/common.ts` | Canonical entity types and shared refs (`EntityReference`, actors). | Source for schema entity inventory and cross-entity references. |
| `src/core/domain/*.ts` (`entry/task/event/project/note/signal/job/notification/view/memory/checkpoint/outbound-draft/audit-transition`) | Domain fields and lifecycle states per entity. | Source for table column/state trigger requirements. |
| `src/core/services/*.ts` (`entry/signal/task/event/outbound-draft/approval/job/checkpoint/memory`) | Actual workflow writes and relations used by services. | Defines practical relation fields and audit transition semantics schema must support. |
| `src/core/app/core-platform.ts` | Wires repository selection and wraps mutating workflows in `withTransaction`. | Integration point proving migration-backed repository is used in app flows. |
| `tests/unit/core/repositories/sqlite-schema.test.ts` | Verifies required tables, state checks, memory key uniqueness, audit indexes. | Regression guard for canonical schema shape and constraints. |
| `tests/unit/core/repositories/sqlite-migrations.test.ts` | Verifies migration ordering, idempotency, rollback, checksum mismatch failures. | Regression guard for migration/versioning correctness. |
| `tests/unit/core/repositories/sqlite-core-repository.test.ts` | Verifies persistence mapping, audit append/list ordering, transaction rollback, paged listing. | Regression guard for repository behavior on top of schema. |
| `tests/integration/database-core-platform.integration.test.ts` | Verifies migrations run at startup, restart durability, approval gates, checkpoint recovery, legacy snapshot import. | End-to-end validation for data-layer behavior under real workflows. |
| `package.json` | Contains `test:integration:db`, `test:unit:core`, `typecheck` scripts. | Execution commands for validating this ticket slice. |
| `docs/references/` | Directory is not present in this workspace. | External reference submodules listed in docs are unavailable locally at research time. |

## Spec Requirements Extracted for API-002
- `docs/design.spec.md:14-25` requires canonical storage for core objects: `Entry`, `Task`, `Event`, `Project`, `Note`, `Signal`, `Job`, `Notification`, `View`, `Memory`, `Checkpoint`.
- `docs/design.spec.md:65` requires auditable and reversible AI writes.
- `docs/design.spec.md:41-48` implies relation and lifecycle persistence across capture, triage/conversion, planning, approvals, job retries, and checkpoint recovery.

## Current Canonical Schema Coverage

### Tables present in baseline migration
- Core objects: `entry`, `task`, `event`, `project`, `note`, `signal`, `job`, `notification`, `view`, `memory`, `checkpoint`
- Workflow-support object: `outbound_draft`
- Audit/versioning support: `audit_transitions`, `schema_migrations`
- Auxiliary relation/index helper: `memory_key_index`

### Relation fields currently modeled
- `task.project_id` (logical relation to `project.id`)
- `task.source_entry_id` (logical relation to `entry.id`)
- `signal.converted_entity_type` + `signal.converted_entity_id` (polymorphic target relation)
- `outbound_draft.source_signal_id` (logical relation to `signal.id`)
- `notification.related_entity_type` + `notification.related_entity_id` (polymorphic relation)
- `memory_key_index.memory_id` (logical relation to `memory.id`)
- `checkpoint.snapshot_entity_refs` + `checkpoint.snapshot_entities` (serialized cross-entity snapshots)
- `audit_transitions.entity_type` + `audit_transitions.entity_id` (append-only cross-entity history link)

### Audit/versioning mechanisms currently implemented
- Append-only `audit_transitions` table captures `from_state`, `to_state`, `actor`, `reason`, `at`, `metadata`.
- `schema_migrations` ledger tracks migration `id`, `name`, `checksum`, `applied_at`.
- Migration runner enforces:
  - deterministic sorted apply order,
  - idempotent re-runs,
  - rollback on failed migration,
  - checksum mismatch rejection for mutated historical migrations.
- Checkpoint snapshots (`checkpoint.snapshot_entities`) plus audit trail support reversible AI-applied writes.

## Constraints and Indexes Present
- Lifecycle/state triggers for: `entry.status`, `task.status`, `event.sync_state`, `project.lifecycle`, `signal.triage_state`, `job.run_state`, `notification.status`, `checkpoint.status`, `outbound_draft.status`.
- Value constraint trigger for `memory.confidence` in `[0,1]`.
- Indexes:
  - `idx_audit_transitions_entity_at (entity_type, entity_id, at)`
  - `idx_audit_transitions_entity_id_at (entity_id, at)`
  - `idx_task_status (status, updated_at)`
  - `idx_event_sync_state (sync_state, updated_at)`
  - `uq_memory_key_index_key (unique key)`
  - `idx_memory_key_index_memory_id (memory_id)`

## Gaps and Risks (If API-002 Is Treated as Open Work)
1. Foreign-key constraints are not enforced at DB level for logical relations (`task.project_id`, `task.source_entry_id`, `outbound_draft.source_signal_id`, etc.).
2. Polymorphic relations (`signal.converted_entity_*`, `notification.related_entity_*`, `audit_transitions.entity_*`) are not DB-validated for referential integrity.
3. No explicit per-row optimistic version column exists on entity tables; versioning is currently migration-level + audit-transition-level.
4. Relation-specific indexes for common join/filter fields are limited (for example `task.project_id`, `task.source_entry_id`, `signal.converted_entity_id`, notification relation filters).
5. `outbound_draft` is essential to required workflows (`docs/design.spec.md:46`) but not listed in section 3 core-object list; schema must keep this consistent as a workflow-support object.

## Proposed File Focus for Any Follow-up on API-002
- `src/core/database/migrations/001_core_schema.sql`
- `src/core/database/migrations/002_core_constraints_indexes.sql`
- `src/core/repositories/sqlite/migrations.ts`
- `src/core/repositories/sqlite/migration-runner.ts`
- `src/core/repositories/sqlite/sqlite-core-repository.ts`
- `src/core/repositories/core-repository.ts`
- `src/core/app/core-platform.ts`
- `tests/unit/core/repositories/sqlite-schema.test.ts`
- `tests/unit/core/repositories/sqlite-migrations.test.ts`
- `tests/unit/core/repositories/sqlite-core-repository.test.ts`
- `tests/integration/database-core-platform.integration.test.ts`

## Suggested Verification Commands
- `bun test tests/unit/core/repositories/sqlite-migrations.test.ts`
- `bun test tests/unit/core/repositories/sqlite-schema.test.ts`
- `bun test tests/unit/core/repositories/sqlite-core-repository.test.ts`
- `bun run test:integration:db`
- `bun run typecheck`
