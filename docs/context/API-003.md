# API-003 Research Context

## Ticket
- ID: `API-003`
- Title: `Add explicit approval and safety enforcement in API boundaries`
- Category: `api`
- Description: `Implement approval checks so outbound actions and external event sync cannot execute without explicit user approval, matching docs/design.spec.md:45, docs/design.spec.md:46, and docs/design.spec.md:64.`

## Relevant Files Field
- No ticket-level `relevantFiles` payload is present for `API-003` in repository ticket metadata.
- Evidence (from `.super-ralph/workflow.db`):
  - `category_review` for `category_id='api'` contains `API-003` with `id/title/description/category/priority`.
  - `json_extract(value, '$.relevantFiles')` for `API-003` resolves to empty/null.

Example query used:

```sql
SELECT
  json_extract(value,'$.id'),
  json_extract(value,'$.title'),
  json_type(value,'$.relevantFiles'),
  json_extract(value,'$.relevantFiles')
FROM json_each(
  (SELECT suggested_tickets FROM category_review WHERE category_id='api')
)
WHERE json_extract(value,'$.id')='API-003';
```

## Paths Reviewed

| Path | Summary | Relevance to API-003 |
| --- | --- | --- |
| `.super-ralph/generated/PROMPT.md` | Generated autonomous prompt with hard constraints (core-first, Effect preference, explicit outbound approvals, jj checkpoints). | Global implementation guardrails for this ticket. |
| `README.md` | Repo overview and canonical pointers to design/engineering/reference docs. | Confirms source-of-truth documents for this research phase. |
| `docs/design.spec.md` | Required workflows and scope boundaries. | Primary requirements for explicit approval and outbound safety (`:45`, `:46`, `:64`). |
| `docs/engineering.choices.md` | Normative engineering constraints (core-first, deterministic logic, side effects at boundaries, tests/typecheck). | Constrains where and how safety enforcement should live. |
| `docs/references.md` | External repos expected under `docs/references/*`. | Reference policy baseline; confirms external pattern sources. |
| `docs/super-ralph.prompt.md` | Canonical autonomous prompt, same constraints as generated prompt. | Reinforces explicit approval and delivery/testing requirements. |
| `.super-ralph/generated/workflow.tsx` | Smithers runtime config and fallback `referenceFiles` list (`PROMPT.md`, `README.md`, `docs`). | Confirms this ticket’s research inputs and orchestration context. |
| `.super-ralph/workflow.db` | Ticket metadata store (`category_review.suggested_tickets`). | Source of truth for API-003 metadata and missing `relevantFiles`. |
| `docs/context/API-001.md` | Prior API-layer research map for workflow routes and approval surface. | Direct predecessor context for API boundary enforcement. |
| `docs/plans/API-001.md` | Original TDD plan for `src/api/workflows/*` contracts/routes/error mapping. | Shows intended API boundary architecture and route semantics. |
| `docs/context/CORE-REV-006.md` | Research context for approval/conflict/auth edge tests. | Captures adjacent rationale and file focus for approval hardening. |
| `docs/plans/CORE-REV-006.md` | TDD plan that introduced 400/403/409 behavior and approval conflict/forbidden handling. | Close implementation precedent for this ticket’s acceptance needs. |
| `src/core/app/core-platform.ts` | Core platform facade; mutating calls wrapped with `repository.withTransaction(...)`; approval APIs exposed via platform methods. | Mutation boundary where approval services are invoked from API wrappers. |
| `src/api/workflows/contracts.ts` | Route key manifest and typed API contract including approval routes. | Defines API boundary surface for request-event-sync/outbound approval paths. |
| `src/api/workflows/routes.ts` | Route path map, payload validators, and route handler wiring (`toRouteHandler`). | Enforces boundary input validation before approval logic execution. |
| `src/api/workflows/workflow-api.ts` | Handler wrappers delegating to `CorePlatform`, mapping failures/defects to `WorkflowApiError`. | Central boundary for consistent error normalization around approval flows. |
| `src/api/workflows/errors.ts` | Maps service error codes to API codes/status (`forbidden`/`conflict`/`not_found`/`validation`). | Required for explicit, safe API error semantics at approval boundaries. |
| `src/api/workflows/http-dispatch.ts` | HTTP dispatcher with route/method matching and sanitized error body mapping. | Final transport boundary enforcing 400/403/404/409/500 behavior. |
| `src/core/services/event-service.ts` | `requestEventSync` transition `local_only -> pending_approval`, with conflict guard and rollback behavior. | Prevents direct sync execution before explicit approval stage is requested. |
| `src/core/services/outbound-draft-service.ts` | `requestOutboundDraftExecution` transition `draft -> pending_approval`, conflict guard, rollback behavior. | Stages outbound actions into pending approval state only. |
| `src/core/services/approval-service.ts` | `approveOutboundAction` enforces `approved: true`, user actor authorization, pending-state preconditions, execution, and rollback. | Core enforcement that blocks outbound execution without explicit user approval. |
| `tests/unit/api/workflows/routes.test.ts` | Validation tests for approval routes (blank `entityId`, blank `eventId`/`draftId`, blank `actor.id`). | Confirms boundary validators reject malformed approval payloads. |
| `tests/unit/api/workflows/errors.test.ts` | Verifies error-code/status mapping (`forbidden` -> 403, `conflict` -> 409, `not_found` -> 404). | Confirms deterministic approval error normalization. |
| `tests/unit/api/workflows/workflow-api.test.ts` | Verifies wrapper preserves route + error metadata and delegates correctly. | Ensures approval failures remain explicit through API wrapper layer. |
| `tests/unit/api/workflows/http-dispatch.test.ts` | Verifies dispatcher returns mapped HTTP statuses for approval errors and sanitized body. | Asserts API transport safety behavior for forbidden/conflict responses. |
| `tests/unit/core/services/event-service.test.ts` | Verifies repeated sync requests are conflicts and no invalid transitions occur. | Guards event sync staging semantics before approval. |
| `tests/unit/core/services/outbound-draft-service.test.ts` | Verifies non-draft execution requests are conflicts. | Guards outbound staging semantics before approval. |
| `tests/unit/core/services/approval-service.test.ts` | Verifies explicit approval, non-user forbidden, duplicate-approval conflicts, and no re-execution on conflict. | Primary unit coverage for explicit approval enforcement. |
| `tests/integration/workflow-api.integration.test.ts` | End-to-end API flow coverage for reject/approve/duplicate approval paths on events and outbound drafts. | Confirms one-time execution and pending state behavior at API boundary. |
| `tests/integration/workflow-api-http.integration.test.ts` | HTTP-level assertions for approval endpoints returning 400/403/409 with sanitized payloads. | Confirms safety enforcement and secure error shaping over transport. |
| `tests/integration/api-data.integration.test.ts` | Integration checks for repeated approval-request operations producing conflict (no duplicate pending transitions). | Confirms state safety under repeated API/core operations. |
| `docs/references/` | Not present in this workspace (`No such file or directory`). | External reference submodules are unavailable in-repo for this ticket run. |

## Spec Requirements Extracted for API-003
- `docs/design.spec.md:45` mandates: local event flow must be `pending approval` before external sync.
- `docs/design.spec.md:46` mandates: outbound draft flow must require explicit approval before execute.
- `docs/design.spec.md:64` mandates: explicit approval for outbound actions in scope boundaries.
- `docs/design.spec.md:70` additionally excludes autonomous outbound posting/sending without approval.

## Current Enforcement Snapshot (API Boundaries + Core)

### Approval staging before execution
- Event sync request path (`requestEventSync`) only allows `event.syncState === "local_only"` and transitions to `pending_approval`; non-local states return `code: "conflict"`.
- Outbound draft request path (`requestOutboundDraftExecution`) only allows `draft.status === "draft"` and transitions to `pending_approval`; non-draft states return `code: "conflict"`.

### Explicit approval gate before side effects
- `approveOutboundAction` fails when `approved !== true` (`code: "invalid_request"`).
- `approveOutboundAction` rejects non-user actors via `assertApprovalActorAuthorized` (`code: "forbidden"`).
- `event_sync` and `outbound_draft` approvals require entity existence and `pending_approval` precondition (`code: "not_found"` / `code: "conflict"` as applicable).
- Outbound side effects execute through `OutboundActionPort` only after all approval checks pass.

### API boundary validation and error safety
- Approval route validators enforce non-empty `eventId`, `draftId`, `entityId`, and `actor.id`.
- `toRouteHandler` converts validation failures into `WorkflowApiError` with `code: "validation"` and `statusCode: 400`.
- `toWorkflowApiError` maps domain/service codes to stable API codes/statuses:
  - `forbidden -> 403`
  - `conflict -> 409`
  - `not_found -> 404`
  - `invalid_request -> validation (400)`
- HTTP dispatcher returns sanitized client bodies (`error`, `route`, `message`) and strips internal fields like `_tag`/`cause`.

### Transaction boundary
- `buildCorePlatform` wraps mutating approval/event/outbound service calls in `repository.withTransaction(...)`, keeping boundary-side effects transactional.

## Research Outcome for API-003
- The repository already contains explicit approval and safety enforcement across:
  - core approval services,
  - API route validation and error mapping,
  - HTTP status/sanitization behavior,
  - and unit/integration regression coverage.
- Because `relevantFiles` is absent for API-003, the implementation file set should be derived from the source/test paths above.

## Proposed File Focus for API-003 Implementation
- `src/core/services/approval-service.ts`
- `src/core/services/event-service.ts`
- `src/core/services/outbound-draft-service.ts`
- `src/api/workflows/routes.ts`
- `src/api/workflows/errors.ts`
- `src/api/workflows/workflow-api.ts`
- `src/api/workflows/http-dispatch.ts`
- `tests/unit/core/services/approval-service.test.ts`
- `tests/unit/core/services/event-service.test.ts`
- `tests/unit/core/services/outbound-draft-service.test.ts`
- `tests/unit/api/workflows/routes.test.ts`
- `tests/unit/api/workflows/errors.test.ts`
- `tests/unit/api/workflows/workflow-api.test.ts`
- `tests/unit/api/workflows/http-dispatch.test.ts`
- `tests/integration/workflow-api.integration.test.ts`
- `tests/integration/workflow-api-http.integration.test.ts`
- `tests/integration/api-data.integration.test.ts`

## Suggested Verification Commands (for implementation phase)
- `bun test tests/unit/core/services/approval-service.test.ts`
- `bun test tests/unit/core/services/event-service.test.ts`
- `bun test tests/unit/core/services/outbound-draft-service.test.ts`
- `bun test tests/unit/api/workflows/routes.test.ts`
- `bun test tests/unit/api/workflows/errors.test.ts`
- `bun test tests/unit/api/workflows/workflow-api.test.ts`
- `bun test tests/unit/api/workflows/http-dispatch.test.ts`
- `bun test tests/integration/workflow-api.integration.test.ts`
- `bun test tests/integration/workflow-api-http.integration.test.ts`
- `bun test tests/integration/api-data.integration.test.ts`
- `bun run test:integration:api`
- `bun run typecheck`
