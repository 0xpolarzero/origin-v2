# API-005 Research Context

## Ticket
- ID: `API-005`
- Title: `Establish enforceable validation commands`
- Category: `testing`
- Priority: `medium`
- Description: Add root `typecheck` and `test` scripts in `package.json` and wire them into workflow checks so each API/data slice is validated per `docs/engineering.choices.md:25` and `docs/engineering.choices.md:41`.

## Relevant Files Field
- No ticket-level `relevantFiles` payload is present for `API-005` in repository ticket metadata.
- Evidence (from `.super-ralph/workflow.db`):
  - Ticket row exists with `id/title/description/category/priority` only.
  - `json_type(value, '$.relevantFiles')` and `json_extract(value, '$.relevantFiles')` resolve to null/empty.

Example queries used:

```sql
SELECT
  category_id,
  json_extract(value,'$.id') AS id,
  json_extract(value,'$.title') AS title,
  json_extract(value,'$.description') AS description,
  json_extract(value,'$.category') AS category,
  json_extract(value,'$.priority') AS priority,
  json_type(value,'$.relevantFiles') AS relevant_type,
  json_extract(value,'$.relevantFiles') AS relevant_files
FROM category_review, json_each(category_review.suggested_tickets)
WHERE json_extract(value,'$.id')='API-005';
```

```sql
SELECT json(value)
FROM category_review, json_each(category_review.suggested_tickets)
WHERE json_extract(value,'$.id')='API-005';
```

## Paths Reviewed

| Path | Summary | Relevance to API-005 |
| --- | --- | --- |
| `.super-ralph/generated/PROMPT.md` | Generated autonomous prompt. Ticket input listed this path twice (same file/content). | Requires delivery loop step `run typecheck + relevant tests`, matching ticket intent. |
| `README.md` | Repo overview and source-of-truth doc map. | Confirms canonical references for implementation decisions. |
| `docs/design.spec.md` | Product requirements and reliability/safety goals. | Reinforces why validation gates must be enforceable. |
| `docs/engineering.choices.md` | Normative guardrails, including per-slice validation requirements. | Primary spec basis for `:25` and `:41` cited in ticket description. |
| `docs/references.md` | Declares expected external submodule references under `docs/references/*`. | Reference policy baseline for research phase. |
| `docs/super-ralph.prompt.md` | Canonical prompt mirror of generated prompt constraints. | Repeats required `typecheck + relevant tests` workflow loop. |
| `docs/references/` | Directory is absent in this workspace (`No such file or directory`). | No local external reference submodules were available to inspect in this run. |
| `package.json` | Contains root scripts `test` and `typecheck` plus slice scripts (`test:core`, `test:integration:api`, `test:integration:workflow`, `test:integration:db`). | Direct file named by ticket; script prerequisites already exist. |
| `.super-ralph/generated/workflow.tsx` | Generated workflow contains `PACKAGE_SCRIPTS`, fallback gate command maps, and runtime config merge wiring. | Primary artifact where script-derived checks are wired into Super Ralph execution. |
| `node_modules/super-ralph/src/cli/gate-config.ts` | Enforces required scripts (`test`, `typecheck`) and derives deterministic `buildCmds`/`testCmds`. | Core command-resolution logic for enforceable validation wiring. |
| `node_modules/super-ralph/src/cli/fallback-config.ts` | Builds fallback config from `gate-config`; fails if no runnable gate commands can be derived. | Fail-closed behavior that prevents no-op validation paths. |
| `node_modules/super-ralph/src/components/ticket-gates.ts` | Resolves per-ticket verify/test/validation commands and rejects placeholder/no-op command patterns. | Per-ticket enforcement layer (`typecheck + category-relevant test`). |
| `node_modules/super-ralph/src/components/SuperRalph.tsx` | Wires ticket gate selection into `ImplementPrompt`, `TestPrompt`, and `ReviewFixPrompt`. | Runtime consumption point for enforceable validation commands. |
| `node_modules/super-ralph/src/components/InterpretConfig.tsx` | Schema/prompt require explicit gate fields and non-empty pre/post-land checks. | Guardrail preventing empty validation command sets from config interpretation. |
| `tests/unit/workflow/gate-config.test.ts` | Verifies required script enforcement and deterministic command derivation. | Unit contract for script-to-gate mapping behavior. |
| `tests/unit/workflow/ticket-gates.test.ts` | Verifies category mapping, required test fallback, and no-op command rejection. | Unit contract for ticket-scoped gate enforcement. |
| `tests/unit/workflow/generated-workflow-gates.test.ts` | Parses generated workflow constants and asserts gate maps are script-derived, non-placeholder, and wired via runtime config merge. | Artifact-level regression guard for workflow command wiring. |
| `tests/unit/workflow/super-ralph-wiring.test.tsx` | Asserts ticket-scoped verify/test/validation commands are passed into workflow prompts. | Confirms end-to-end wiring from gate resolution to execution prompts. |
| `tests/integration/workflow-gate-policy.integration.test.ts` | Integration checks for fallback config, gate mapping, category-specific commands, and required script presence. | Strongest executable policy reference for this ticket area. |
| `docs/plans/CORE-REV-004.md` | Original TDD plan that introduced deterministic gate helpers and per-ticket command wiring. | Closest implementation precedent for this validation-command ticket. |
| `docs/plans/WF-AUDIT-004.md` | Follow-up plan focused on removing no-op fallback behavior and hardening generated workflow wiring. | Additional precedent for strict, fail-closed gate behavior. |
| `docs/context/WF-AUDIT-004.md` | Prior research context for nearly identical gate-enforcement problem. | Useful continuity reference; parts are now historical/stale after subsequent fixes. |
| `docs/context/WF-AUDIT-004-review-fix-tdd.md` | Review-fix evidence for later gate regressions. | Shows existing red/green test-first maintenance pattern for this area. |

## Spec and Guardrail Requirements for API-005
- `docs/engineering.choices.md:25` requires: run typecheck and relevant tests on each implementation slice.
- `docs/engineering.choices.md:41` requires autonomous workflow validation (`typecheck/tests`) before progressing.
- `.super-ralph/generated/PROMPT.md:27` and `docs/super-ralph.prompt.md:27` require `run typecheck + relevant tests` as a mandatory delivery step.
- `AGENTS.md` requires each atomic commit to pass relevant tests/typecheck for the changed slice.

## Current Implementation Snapshot
1. Root script prerequisites are already present in `package.json`:
   - `test`
   - `typecheck`
   - `test:core`
   - `test:integration:api`
   - `test:integration:workflow`
   - `test:integration:db`
2. `gate-config.ts` enforces required `test` + `typecheck` scripts and derives runner-prefixed commands (for Bun: `bun run ...`).
3. `fallback-config.ts` fails closed if runnable gate commands cannot be derived from scripts (or Go/Rust fallbacks).
4. `ticket-gates.ts` rejects placeholder/no-op patterns and resolves per-ticket verify/validation commands.
5. `SuperRalph.tsx` wires ticket-scoped commands into implement/test/review-fix phases.
6. Unit and integration tests already assert script presence, command mapping, category-specific command selection, and no-placeholder command shape.

## Observed Gaps and Risks Relevant to API-005
1. **Category-to-slice mapping ambiguity for API tickets marked as `testing`:**
   - `API-004` and `API-005` metadata categories are `testing`, not `api`/`db`.
   - `ticket-gates.ts` currently maps only `core`, `api`, `workflow`, and `db/data`; unknown categories fall back to `test`.
   - Effect: these tickets currently resolve to `bun run test` rather than a targeted API/data integration command.
2. **Generated workflow script-body drift risk:**
   - `.super-ralph/generated/workflow.tsx` currently embeds `PACKAGE_SCRIPTS.typecheck` using `tsconfig.json`, while repo `package.json` uses `tsconfig.typecheck.json`.
   - Gate execution still uses `bun run typecheck`, so runtime command name is correct; however, generated artifact metadata is stale and can confuse policy assertions.
3. **No explicit test currently asserts API/testing category should prefer API/data slice commands:**
   - Existing integration tests assert behavior for categories `core`, `api`, `workflow`, `db`, and `unknown`, but not `testing` or mixed API/data policy.

## Derived File Focus for Implementation
(derived because ticket metadata has no `relevantFiles`)

### Primary implementation targets
- `package.json` (confirm root scripts remain authoritative and non-empty)
- `node_modules/super-ralph/src/components/ticket-gates.ts` (category normalization/mapping policy)
- `node_modules/super-ralph/src/cli/gate-config.ts` (if API/data aliasing or mapping needs extension)
- `node_modules/super-ralph/src/cli/fallback-config.ts` (if fallback mapping strategy changes)
- `.super-ralph/generated/workflow.tsx` (regenerate to sync embedded scripts/config)
- `patches/super-ralph-codex-schema.patch` (persist any `super-ralph` source changes)

### Verification and policy contracts
- `tests/unit/workflow/gate-config.test.ts`
- `tests/unit/workflow/ticket-gates.test.ts`
- `tests/unit/workflow/generated-workflow-gates.test.ts`
- `tests/unit/workflow/super-ralph-wiring.test.tsx`
- `tests/integration/workflow-gate-policy.integration.test.ts`

## Suggested Verification Commands (Implementation Phase)
- `bun test tests/unit/workflow/gate-config.test.ts`
- `bun test tests/unit/workflow/ticket-gates.test.ts`
- `bun test tests/unit/workflow/generated-workflow-gates.test.ts`
- `bun test tests/unit/workflow/super-ralph-wiring.test.tsx`
- `bun test tests/integration/workflow-gate-policy.integration.test.ts`
- `bun run typecheck`

## Research Summary
- API-005 metadata has no `relevantFiles`; scope must be derived from workflow gate code/tests plus root scripts.
- Root `test`/`typecheck` scripts and strict workflow gate wiring are already implemented in the current repo.
- The main remaining research-noted questions for implementation are category mapping policy for `testing` API tickets and synchronizing generated workflow script metadata with current `package.json`.
