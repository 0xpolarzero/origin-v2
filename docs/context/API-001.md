# API-001 Research Context

## Ticket
- ID: `API-001`
- Title: `Scaffold API workflows required by design spec`
- Category: `api`
- Description: Create the initial API layer and handlers for capture->triage->conversion, signal ingestion, planning adjustments, event approval/sync gating, outbound approval, job run/retry, and AI inspection/recovery workflows defined in `docs/design.spec.md:41`.

## Relevant Files Field
- No ticket-level `relevantFiles` payload was found for `API-001`.
- Evidence from `.super-ralph/workflow.db`:
  - `category_review.suggested_tickets` contains `id/title/description/category/priority` for `API-001`.
  - `json_type(ticket, '$.relevantFiles')` resolves to null/empty for `API-001`.

## Paths Reviewed

| Path | Summary | Relevance to API-001 |
| --- | --- | --- |
| `.super-ralph/generated/PROMPT.md` | Generated autonomous prompt (listed twice in ticket input) with hard constraints: core-first, Effect-first, explicit outbound approvals, per-slice test/typecheck, jj checkpoints. | Governs implementation and delivery constraints for this API ticket. |
| `README.md` | Repo purpose and canonical docs pointers (`docs/design.spec.md`, `docs/engineering.choices.md`, `docs/references.md`, `docs/super-ralph.prompt.md`). | Confirms source-of-truth documents for scope interpretation. |
| `docs/design.spec.md` | Defines required workflows in section 5 (`docs/design.spec.md:41-48`) and safety boundaries in section 7 (`docs/design.spec.md:60-65`). | Primary functional requirements for the ticket. |
| `docs/engineering.choices.md` | Normative guardrails (Effect usage, core-first rule, deterministic logic, boundary side effects, per-slice validation). | Constrains API layer architecture and testing approach. |
| `docs/references.md` | Lists expected external references under `docs/references/*`. | Indicates required pattern sources before major implementation. |
| `docs/super-ralph.prompt.md` | Canonical prompt mirroring generated prompt requirements. | Reinforces execution/testing/approval constraints. |
| `.super-ralph/generated/workflow.tsx` | Workflow wiring and fallback config (`referenceFiles`: generated prompt, README, docs). | Confirms how this research phase is parameterized. |
| `.super-ralph/workflow.db` | Suggested ticket metadata includes `API-001`; no per-ticket `relevantFiles`. | Source of ticket provenance and metadata evidence. |
| `docs/test-suite-findings.md` | Historical findings from pre-implementation era (now partially stale). | Useful context for why API scaffolding ticket existed initially. |
| `docs/context/CORE-REV-001.md` | Baseline research format + early gap narrative. | Continuity reference for context structure. |
| `docs/context/CORE-REV-002.md` | Prior workflow API coverage matrix; identifies signal ingestion/outbound approval lifecycle additions. | Direct predecessor analysis for API workflow surfaces. |
| `docs/context/CORE-REV-003.md` | Database/repository research and persistence coverage for workflow entities and auditability. | Confirms data-layer support available to API handlers. |
| `docs/context/CORE-REV-003-review-fix-tdd.md` | Review-fix evidence for transaction boundaries, migration safety, and schema index hardening. | Relevant to API mutation reliability expectations. |
| `docs/plans/CORE-REV-001.md` | TDD plan for initial domain/services and platform API surface. | Background on intended workflow API scaffolding. |
| `docs/plans/CORE-REV-002.md` | TDD plan for signal ingestion and outbound draft approval gate lifecycle. | Documents expected API edges for this ticket area. |
| `docs/plans/CORE-REV-003.md` | TDD plan for SQLite schema/migrations and DB-backed repository integration. | Shows persistence foundation now backing API workflows. |
| `package.json` | Validation commands exist (`test:integration:api`, `test:integration:workflow`, `test:integration:db`, `typecheck`). | Defines verification gates for API slice changes. |
| `src/core/app/core-platform.ts` | In-process API facade exposing workflow methods and transaction wrapping via `withMutationBoundary`. | Central API layer currently implementing the ticket scope. |
| `src/core/services/entry-service.ts` | Capture, AI suggestion, suggestion edit/reject, and entry->task acceptance with audit transitions. | Covers workflow: capture -> suggest -> accept/edit/reject. |
| `src/core/services/signal-service.ts` | Signal ingestion, triage, and conversion to task/event/note/project/outbound draft with linked audits. | Covers workflow: signal ingestion -> triage -> conversion. |
| `src/core/services/task-service.ts` | Task planning transitions: complete/defer/reschedule. | Covers workflow: planning loop adjustments. |
| `src/core/services/event-service.ts` | Event sync request transitions event to `pending_approval` and creates approval notification. | Covers workflow: local event -> pending approval gate. |
| `src/core/services/outbound-draft-service.ts` | Moves outbound draft `draft -> pending_approval`, creates notification, appends audit, includes rollback on partial failure. | Covers explicit approval pre-stage for outbound drafts. |
| `src/core/services/approval-service.ts` | Approval gate for `event_sync` and `outbound_draft`, with strict preconditions, staged execution, rollback, and audit transitions. | Covers workflows: event approval/sync gating and outbound approval execution. |
| `src/core/services/job-service.ts` | Job run recording, inspection, and retry transitions. | Covers workflow: automation run -> inspect -> retry/fix. |
| `src/core/services/checkpoint-service.ts` | Checkpoint create/keep/recover with entity snapshot restoration and audit transitions. | Covers workflow: AI-applied update -> inspect -> keep/recover. |
| `src/core/repositories/core-repository.ts` | Persistence/audit contract and transaction boundary interface. | Defines API handler persistence and transactional semantics. |
| `src/core/repositories/in-memory-core-repository.ts` | Deterministic in-memory implementation; transaction is no-op passthrough. | Baseline test backend for API behavior. |
| `src/core/repositories/file-core-repository.ts` | Snapshot persistence/load for restart durability and local-first flows. | Supports file-backed local-first API behavior in integration tests. |
| `src/core/repositories/sqlite/sqlite-core-repository.ts` | SQLite-backed persistence, paged reads, JSON mapping, audit persistence, `BEGIN IMMEDIATE` transaction wrapper. | Production-style API persistence backend and mutation boundary. |
| `src/core/repositories/sqlite/migration-runner.ts` | Migration ledger, ordered apply, checksum mismatch protection, rollback on failed migration. | Ensures API layer can bootstrap schema safely. |
| `src/core/repositories/sqlite/migrations.ts` | Defines migration set and checksums for baseline/constraints migrations. | Ties API repository startup to deterministic schema state. |
| `src/core/database/migrations/001_core_schema.sql` | Baseline tables for required entities plus `audit_transitions` and `memory_key_index`. | Data schema supporting all required workflow entities. |
| `src/core/database/migrations/002_core_constraints_indexes.sql` | Lifecycle state triggers and critical indexes, including outbound draft and audit indexes. | Enforces API-level state invariants at DB boundary. |
| `tests/integration/api-data.integration.test.ts` | End-to-end API workflow tests: capture/suggest, ingest/triage/convert, event/outbound approvals, restart durability of pending states. | Primary acceptance coverage for API-001 scope. |
| `tests/integration/workflow-automation.integration.test.ts` | Integration tests for planning transitions, job inspect/retry, checkpoint keep/recover. | Confirms non-UI workflow APIs required by design spec section 5. |
| `tests/integration/core-platform.integration.test.ts` | Core platform API integration tests including transaction wrapper assertion. | Validates mutation APIs run inside repository transaction boundaries. |
| `tests/integration/database-core-platform.integration.test.ts` | DB-backed integration tests for migration bootstrap, approvals, restart durability, checkpoint reversibility, legacy import. | Validates API workflows over persistent backend. |
| `tests/unit/core/services/signal-service.test.ts` | Unit coverage for ingestion/triage/conversion branches and error paths. | Fine-grained behavior checks for signal API handlers. |
| `tests/unit/core/services/outbound-draft-service.test.ts` | Unit coverage for outbound draft request flow and rollback/error handling. | Fine-grained behavior checks for outbound approval staging. |
| `tests/unit/core/services/approval-service.test.ts` | Unit coverage for explicit approval enforcement, entity/state validation, staged outbound execution, rollback scenarios. | Fine-grained behavior checks for safety-critical approval gate. |

## Spec Requirements Extracted (`docs/design.spec.md:41-48`, `docs/design.spec.md:60-65`)
- Capture -> persist -> AI suggestion -> user accept/edit/reject -> structured entity.
- Signal ingestion -> triage -> convert to task/event/note/project or outbound draft.
- Planning loop -> adjust schedule -> complete/defer/reschedule.
- Local event -> pending approval -> external sync on explicit approval.
- Outbound draft -> explicit approval -> execute.
- Automation run -> inspect -> retry/fix.
- AI-applied update -> inspect -> keep/recover.
- Safety boundaries: local-first authored data, explicit outbound approval, auditable/reversible AI writes.

## Current API Workflow Coverage (Repository Snapshot)

| Required workflow | Current API surface | Status | Evidence |
| --- | --- | --- | --- |
| Capture -> persist -> suggestion -> accept/edit/reject | `captureEntry`, `suggestEntryAsTask`, `editEntrySuggestion`, `rejectEntrySuggestion`, `acceptEntryAsTask` | Implemented | `src/core/app/core-platform.ts`, `src/core/services/entry-service.ts`, `tests/integration/api-data.integration.test.ts` |
| Signal ingestion -> triage -> conversion | `ingestSignal`, `triageSignal`, `convertSignal` | Implemented | `src/core/services/signal-service.ts`, `tests/unit/core/services/signal-service.test.ts`, `tests/integration/api-data.integration.test.ts` |
| Planning adjustments | `completeTask`, `deferTask`, `rescheduleTask` | Implemented | `src/core/services/task-service.ts`, `tests/integration/workflow-automation.integration.test.ts` |
| Event approval/sync gating | `requestEventSync` + `approveOutboundAction(actionType='event_sync')` | Implemented | `src/core/services/event-service.ts`, `src/core/services/approval-service.ts`, DB integration tests |
| Outbound approval | `requestOutboundDraftExecution` + `approveOutboundAction(actionType='outbound_draft')` | Implemented | `src/core/services/outbound-draft-service.ts`, `src/core/services/approval-service.ts`, unit + integration tests |
| Job run/inspect/retry | `createJob`, `recordJobRun`, `inspectJobRun`, `retryJob` | Implemented | `src/core/services/job-service.ts`, `tests/integration/workflow-automation.integration.test.ts` |
| AI inspection/recovery | `createWorkflowCheckpoint`, `keepCheckpoint`, `recoverCheckpoint` | Implemented | `src/core/services/checkpoint-service.ts`, `tests/integration/workflow-automation.integration.test.ts`, DB integration tests |

## Architecture Notes for Implementation
- Current "API layer" is an in-process facade (`CorePlatform`) rather than transport-specific HTTP/IPC handlers.
- All mutating API methods are wrapped via `repository.withTransaction(...)` in `buildCorePlatform`.
- Outbound side effects are abstracted by `OutboundActionPort` to enforce explicit approval before execution.
- Persistence backends are pluggable (`in-memory`, `file snapshot`, `sqlite`) with shared repository contract and audit trail semantics.

## Gaps / Clarifications for API-001 Implementation Phase
1. Clarify whether "handlers" in ticket wording means:
   - in-process workflow methods (already present), or
   - external transport handlers (HTTP/IPC) not yet modeled under `src/api/*`.
2. No explicit route/contract document currently maps request/response/error semantics for transport boundaries.
3. Caller-level validation/auth policy is not represented; current safeguards are domain/service preconditions.
4. `docs/references/*` submodules are not present locally, so external reference implementations cannot be inspected in-repo.

## Proposed File Focus If Additional API-001 Work Is Needed
- `src/core/app/core-platform.ts`
- `src/core/services/entry-service.ts`
- `src/core/services/signal-service.ts`
- `src/core/services/task-service.ts`
- `src/core/services/event-service.ts`
- `src/core/services/outbound-draft-service.ts`
- `src/core/services/approval-service.ts`
- `src/core/services/job-service.ts`
- `src/core/services/checkpoint-service.ts`
- `tests/integration/api-data.integration.test.ts`
- `tests/integration/workflow-automation.integration.test.ts`
- `tests/unit/core/services/approval-service.test.ts`
- `tests/unit/core/services/outbound-draft-service.test.ts`
- `tests/unit/core/services/signal-service.test.ts`

## Validation Commands for This Slice
- `bun run typecheck`
- `bun run test:integration:api`
- `bun run test:integration:workflow`
- `bun run test:integration:db`
- `bun run test:unit:core`
